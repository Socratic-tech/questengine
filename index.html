<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aethelgard: The Living World</title>
    <style>
        :root { 
            --cga-blue: #0000AA; --cga-cyan: #55FFFF; --cga-white: #FFFFFF; 
            --cga-magenta: #FF55FF; --cga-yellow: #FFFF55; --cga-red: #FF5555;
        }
        body { background: #000; color: var(--cga-white); font-family: 'Courier New', monospace; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        #game-container { width: 100%; max-width: 900px; height: 100vh; display: flex; flex-direction: column; border-left: 2px solid #333; border-right: 2px solid #333; position: relative; }
        
        #status-bar { background: var(--cga-blue); color: var(--cga-white); padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--cga-white); font-size: 0.85rem; }
        #display { flex-grow: 1; overflow-y: auto; padding: 25px; line-height: 1.6; background: #050505; }
        #input-area { background: #111; padding: 20px; border-top: 2px solid var(--cga-white); display: flex; align-items: center; }
        #cmd-input { background: transparent; border: none; color: var(--cga-cyan); font-family: inherit; font-size: 1.2rem; width: 100%; outline: none; margin-left: 10px; }
        
        .room-title { color: var(--cga-magenta); font-size: 1.4rem; font-weight: bold; text-decoration: underline; margin-bottom: 10px; display: block; }
        .npc-text { color: var(--cga-yellow); font-style: italic; }
        .npc-name { color: var(--cga-magenta); font-weight: bold; }
        .user-cmd { color: var(--cga-cyan); font-weight: bold; margin: 15px 0 5px 0; }
        .error-text { color: var(--cga-red); font-weight: bold; }
        .sys-note { color: #888; font-size: 0.9rem; font-style: italic; }
        .win-screen { text-align: center; margin-top: 50px; border: 4px double var(--cga-yellow); padding: 20px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-bar">
        <span id="stat-loc">Location: Initializing...</span>
        <span id="stat-score">Score: 0</span>
        <span id="stat-step">Step: 1/20</span>
    </div>
    <div id="display"></div>
    <div id="input-area">
        <span>></span>
        <input type="text" id="cmd-input" autofocus placeholder="Type 'HELP' if stuck...">
    </div>
</div>

<script>
/** 1. GAME STATE **/
let state = {
    current: "forest_edge",
    inv: [],
    flags: { 
        rats_cleared: false, 
        has_key: false, 
        gate_open: false, 
        bridge_visible: false, 
        guard_dead: false,
        ale_unlocked: false,
        game_over: false
    },
    score: 0,
    activeNPC: null
};

/** 2. WORLD DATA **/
const world = {
    "forest_edge": {
        step: 1, title: "The Forest Edge",
        desc: () => "A misty trailhead. " + (world.forest_edge.items.includes("coin") ? "A shiny **coin** lies in the grass. " : "") + "To the WEST is a ruined merchant wagon. NORTH leads to Oakhaven Village.",
        exits: { north: "village_square", west: "wagon" },
        items: ["coin"],
        hint: "Take the coin first. Then check the wagon to the West."
    },
    "wagon": {
        step: 2, title: "The Ruined Wagon",
        desc: () => "The merchant's cart is splintered. " + (world.wagon.items.includes("hammer") ? "A heavy iron **hammer** is stuck in a crate. " : "") + "The trail leads back EAST.",
        exits: { east: "forest_edge" },
        items: ["hammer"],
        hint: "Pick up the hammer. You'll need it to smash things later."
    },
    "village_square": {
        step: 3, title: "Oakhaven Square",
        desc: () => state.flags.game_over ? "The sun is back! The village is safe." : "A gloomy village center. An **Elder** sits by a dry fountain. NORTH to the mountains, WEST to the Tavern.",
        exits: { south: "forest_edge", north: "mountain_pass", west: "tavern" },
        items: [],
        npcs: {
            "elder": {
                name: "Elder Haim",
                intro: () => state.flags.has_key ? "I see you've helped the Smith! He's a good man." : "Our world is fading, traveler.",
                dialogue: {
                    root: {
                        text: "The Sun Gem was stolen by Malakor. We need a hero.",
                        options: [
                            { text: "Where is Malakor?", next: "malakor" },
                            { text: "I'll see what I can do.", next: "exit" }
                        ]
                    },
                    malakor: {
                        text: "He dwells in the Citadel beyond the Frozen Peaks. But the gates are sealed.",
                        options: [{ text: "I understand.", next: "exit" }]
                    }
                }
            }
        }
    },
    "mountain_pass": {
        step: 4, title: "The High Pass",
        desc: () => state.flags.has_key ? "The wind is cold, but the **Blacksmith** is now happily working. NORTH to the gate." : "A rocky path. A **Blacksmith** is frantically searching the ground.",
        exits: { south: "village_square", north: "sorcerer_gate" },
        npcs: {
            "blacksmith": {
                name: "Ironheart",
                intro: () => state.flags.has_key ? "The forge is hot again!" : "I can't talk! I've lost my silver coin!",
                dialogue: {
                    root: {
                        text: () => state.flags.has_key ? "Be careful at the gate. It requires a Sigil." : "If you find my coin, I'll give you the Silver Key.",
                        options: [{ text: "I'll keep looking.", next: "exit" }]
                    }
                }
            }
        },
        interactions: {
            "coin": { 
                npc: "blacksmith", 
                msg: "Ironheart gasps, 'My coin!' He hands you a **silver_key**. 'Use this at the Tavern.'", 
                get: "silver_key", flag: "has_key" 
            }
        }
    },
    "tavern": {
        step: 5, title: "The Sleeping Dragon",
        desc: "A smoky tavern. A hatch leads DOWN. EAST leads back to the square.",
        exits: { east: "village_square", down: "cellar" },
        condition: (d) => (d === "down" && !state.inv.includes("silver_key")) ? "The hatch is locked with a silver padlock." : null,
        npcs: {
            "barman": {
                name: "Boran",
                intro: () => state.flags.ale_unlocked ? "Ready for another round of Dragon-Fire?" : "Welcome. Don't go in the cellar.",
                dialogue: {
                    root: {
                        text: "What can I do for you?",
                        options: [
                            { text: "Tell me about the cellar.", next: "cellar" },
                            { text: "I need Dragon-Fire Ale.", next: "ale_check" },
                            { text: "Nothing, thanks.", next: "exit" }
                        ]
                    },
                    cellar: { text: "It's full of rats. My lantern is down there, but it's too dangerous.", options: [{text:"I see.", next:"exit"}] },
                    ale_check: {
                        text: () => state.flags.ale_unlocked ? "Sure thing, here's a bottle." : "That's for champions only. Help the village first.",
                        options: [
                            { text: "I'll prove myself.", next: "exit" },
                            { text: "Give it to me now.", next: "exit", cond: () => state.flags.ale_unlocked, get: "ale" }
                        ]
                    }
                }
            }
        },
        interactions: {
            "sigil": { flag: "ale_unlocked", msg: "Boran sees your Sigil. 'A hero! Here, take some **ale** for your journey.'", get: "ale" }
        }
    },
    "cellar": {
        step: 6, title: "The Dark Cellar",
        desc: () => state.flags.rats_cleared ? "The rats are gone. A **lantern** is here! Go UP." : "Hissing rats block the way. You need a tool to scare them. Go UP.",
        exits: { up: "tavern" },
        items: [],
        interactions: {
            "hammer": { flag: "rats_cleared", msg: "You swing the hammer! The rats flee. You find a **lantern**.", get: "lantern" }
        }
    },
    "sorcerer_gate": {
        step: 9, title: "The Sorcerer's Gate",
        desc: () => state.flags.gate_open ? "The iron gate is open. The Frozen Peaks lie NORTH." : "A massive iron gate blocks the path NORTH.",
        exits: { south: "mountain_pass", north: "frozen_peaks" },
        condition: (d) => (d === "north" && !state.flags.gate_open) ? "The gate is sealed by magic." : null,
        interactions: {
            "sigil": { flag: "gate_open", msg: "The Sigil fits perfectly. The gate grinds open!", score: 20 }
        }
    },
    "frozen_peaks": {
        step: 10, title: "The Frozen Peaks",
        desc: "A blinding snowstorm. A **Hermit** huddles by a fire. To the NORTH is a massive chasm.",
        exits: { south: "sorcerer_gate", north: "chasm" },
        npcs: {
            "hermit": {
                name: "The Hermit",
                intro: "So cold...",
                dialogue: {
                    root: {
                        text: "The bridge is invisible. Only 'Dragon-Fire Ale' can reveal the path.",
                        options: [{ text: "I'll go find some.", next: "exit" }]
                    }
                }
            }
        }
    },
    "chasm": {
        step: 11, title: "The Crystal Chasm",
        desc: () => state.flags.bridge_visible ? "The ale reveals a shimmering bridge leading NORTH." : "A bottomless drop. You can't see a way across to the NORTH.",
        exits: { south: "frozen_peaks", north: "citadel_interior" },
        condition: (d) => (d === "north" && !state.flags.bridge_visible) ? "You'd fall into the abyss!" : null,
        interactions: {
            "ale": { flag: "bridge_visible", msg: "You drink the ale. Your vision glows, revealing a bridge!", score: 10 }
        }
    },
    "citadel_interior": {
        step: 15, title: "Citadel Hall",
        desc: "Dark stone and green fire. A library is WEST. The Throne is NORTH.",
        exits: { south: "chasm", west: "library", north: "throne_room" },
        items: []
    },
    "library": {
        step: 16, title: "The Forbidden Library",
        desc: "Ancient scrolls line the walls. A **scroll** of dispelling sits on a desk. Go EAST.",
        exits: { east: "citadel_interior" },
        items: ["scroll"],
        hint: "Take the scroll. It's the only way to beat Malakor."
    },
    "throne_room": {
        step: 20, title: "The Throne of Shadow",
        desc: "Malakor the Sorcerer sits here, clutching the Sun Gem.",
        exits: { south: "citadel_interior" },
        npcs: {
            "malakor": {
                name: "Malakor",
                intro: "You've come far, but you will end here.",
                dialogue: {
                    root: {
                        text: "Surrender now and I may let you live.",
                        options: [
                            { text: "I will never surrender! [USE SCROLL]", next: "win", cond: () => state.inv.includes("scroll") },
                            { text: "I'm not ready.", next: "exit" }
                        ]
                    },
                    win: { text: "The scroll glows! Malakor vanishes in a scream of light!", options: [{text: "TAKE GEM", next: "victory"}] }
                }
            }
        }
    }
};

/** 3. ENGINE CORE **/
const display = document.getElementById('display');
const inputField = document.getElementById('cmd-input');

function print(text, cls = "") {
    const p = document.createElement('p');
    if (cls) p.className = cls;
    p.innerHTML = text;
    display.appendChild(p);
    display.scrollTop = display.scrollHeight;
}

function updateHUD() {
    const room = world[state.current];
    document.getElementById('stat-loc').innerText = `Location: ${room.title}`;
    document.getElementById('stat-score').innerText = `Score: ${state.score}`;
    document.getElementById('stat-step').innerText = `Step: ${room.step}/20`;
}

function render() {
    const room = world[state.current];
    display.innerHTML = "";
    print(room.title, "room-title");
    
    // Dynamic Description
    const d = (typeof room.desc === "function") ? room.desc() : room.desc;
    print(d);
    
    if (room.items?.length > 0) print(`Visible Items: <span style="color:var(--cga-cyan)">${room.items.join(", ")}</span>`);
    
    const npcNames = Object.keys(room.npcs || {});
    if (npcNames.length > 0) print(`People here: <span class="npc-name">${npcNames.join(", ").toUpperCase()}</span>`);
    
    updateHUD();
}

function handleDialogue(input) {
    const npc = state.activeNPC.data;
    const node = npc.dialogue[state.activeNPC.node];
    const choice = parseInt(input) - 1;

    if (node.options[choice]) {
        const opt = node.options[choice];
        
        if (opt.cond && !opt.cond()) {
            print("You don't meet the requirements for that.", "error-text");
            return;
        }

        if (opt.next === "exit") {
            state.activeNPC = null;
            print("Conversation ended.");
            render();
        } else if (opt.next === "victory") {
            state.game_over = true;
            renderWin();
        } else {
            state.activeNPC.node = opt.next;
            displayDialogue();
        }
    } else {
        print("Invalid choice. Type the number.", "error-text");
    }
}

function displayDialogue() {
    const npc = state.activeNPC.data;
    const node = npc.dialogue[state.activeNPC.node];
    display.innerHTML = "";
    print(npc.name, "npc-name");
    
    const introTxt = (typeof npc.intro === "function") ? npc.intro() : npc.intro;
    const nodeTxt = (typeof node.text === "function") ? node.text() : node.text;
    
    print(`<span class="sys-note">${introTxt}</span>`);
    print(`"${nodeTxt}"`, "npc-text");
    
    node.options.forEach((opt, i) => {
        print(`${i + 1}. ${opt.text}`, "user-cmd");
    });
}

function handle(raw) {
    if (state.activeNPC) { handleDialogue(raw); return; }

    const input = raw.toLowerCase().trim();
    const parts = input.split(" ");
    const verb = parts[0];
    const room = world[state.current];

    print(`> ${raw}`, "user-cmd");

    // Help
    if (verb === "help" || verb === "hint") {
        print(`SYSTEM: ${room.hint || "Try moving or talking to people."}`, "sys-note");
        return;
    }

    // Movement
    const dirs = ["north", "south", "east", "west", "up", "down"];
    if (dirs.includes(verb) || (verb === "go" && dirs.includes(parts[parts.length-1]))) {
        const d = dirs.includes(verb) ? verb : parts[parts.length-1];
        if (room.exits[d]) {
            const err = room.condition ? room.condition(d) : null;
            if (err) print(err, "error-text");
            else { state.current = room.exits[d]; render(); }
        } else print("You can't go that way.", "error-text");
        return;
    }

    // Talk
    if (verb === "talk" || verb === "speak" || verb === "ask") {
        const target = room.npcs[parts[parts.length-1]] || Object.values(room.npcs || {})[0];
        if (target) { state.activeNPC = { data: target, node: "root" }; displayDialogue(); }
        else print("No one here to talk to.");
        return;
    }

    // Give / Use
    if (verb === "give" || verb === "use") {
        const item = state.inv.find(i => input.includes(i));
        if (item) {
            const action = room.interactions?.[item];
            if (action) {
                if (action.npc && !room.npcs[action.npc]) {
                    print(`The ${action.npc} isn't here.`);
                } else {
                    print(action.msg, "npc-text");
                    if (action.get) { state.inv.push(action.get); print(`<span class="sys-note">Received: ${action.get}</span>`); }
                    if (action.flag) state.flags[action.flag] = true;
                    state.inv = state.inv.filter(i => i !== item);
                    state.score += 10;
                    render();
                }
            } else print("Nothing happened.");
        } else print("You don't have that.");
        return;
    }

    // Take
    if (verb === "take" || verb === "get") {
        const itemName = parts[parts.length-1];
        if (room.items?.includes(itemName)) {
            state.inv.push(itemName);
            room.items = room.items.filter(i => i !== itemName);
            print(`Took the ${itemName}.`);
            updateHUD();
        } else print("It's not here.");
        return;
    }

    // Inv
    if (verb === "inv" || verb === "inventory") {
        print("Inventory: " + (state.inv.join(", ") || "Empty"));
        return;
    }

    print("I don't understand that command. Try 'GO', 'TALK', 'TAKE', or 'USE'.", "error-text");
}

function renderWin() {
    display.innerHTML = `<div class="win-screen">
        <h1 style="color:var(--cga-yellow)">VICTORY!</h1>
        <p>You have defeated Malakor and returned the Sun Gem to Oakhaven.</p>
        <p>Final Score: ${state.score + 50}</p>
        <button onclick="location.reload()" style="background:var(--cga-magenta); padding:10px; border:none; cursor:pointer;">PLAY AGAIN</button>
    </div>`;
}

// Init
window.onload = () => {
    render();
    print("<b>AETHELGARD ONLINE.</b> Type 'HELP' if you are lost.", "sys-note");
    inputField.focus();
};

inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { handle(inputField.value); inputField.value = ''; }
});
</script>
</body>
</html>
