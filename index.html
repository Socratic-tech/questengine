<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aethelgard</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
          box-sizing: border-box;
        }
        
        :root { 
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #2a2f4a;
            --accent-cyan: #00d9ff;
            --accent-magenta: #ff006e;
            --accent-gold: #ffbe0b;
            --accent-green: #06ffa5;
            --text-primary: #e8f4f8;
            --border-glow: rgba(0, 217, 255, 0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body { height: 100%; }
        
        body { 
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1436 100%);
            color: var(--text-primary);
            font-family: 'Courier New', 'Consolas', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            width: 100%;
        }
        
        #game-container { 
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 60px rgba(0, 217, 255, 0.2);
        }
        
        #main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #inventory-panel {
            width: 280px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-left: 3px solid var(--accent-cyan);
            padding: 20px;
            overflow-y: auto;
            box-shadow: -4px 0 20px var(--border-glow);
        }
        
        #inventory-panel h2 {
            color: var(--accent-cyan);
            font-size: 1.1rem;
            margin-bottom: 15px;
            text-shadow: 0 0 10px var(--accent-cyan);
            border-bottom: 2px solid var(--accent-cyan);
            padding-bottom: 10px;
        }
        
        #inventory-list {
            margin-bottom: 30px;
        }
        
        .inventory-item {
            background: rgba(0, 217, 255, 0.1);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            color: var(--accent-green);
            font-size: 0.9rem;
        }
        
        .inventory-empty {
            color: rgba(232, 244, 248, 0.4);
            font-style: italic;
            padding: 10px;
            text-align: center;
        }
        
        #map-section {
            margin-top: 20px;
        }
        
        #mini-map {
            font-size: 0.65rem;
            line-height: 1.1;
            white-space: pre;
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 4px;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 0 15px var(--border-glow), inset 0 0 15px rgba(0, 217, 255, 0.1);
            color: var(--accent-gold);
            overflow-x: auto;
        }
        
        .map-current {
            color: var(--accent-magenta);
            font-weight: bold;
            text-shadow: 0 0 8px var(--accent-magenta);
        }
        
        .map-visited {
            color: var(--accent-cyan);
        }
        
        .map-unvisited {
            color: rgba(232, 244, 248, 0.3);
        }
        
        /* Opening Instruction Screen */
        #intro-overlay { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            animation: fadeIn 0.5s ease-in;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px var(--accent-cyan), 0 0 30px var(--accent-cyan); }
            50% { text-shadow: 0 0 30px var(--accent-cyan), 0 0 40px var(--accent-cyan), 0 0 50px var(--accent-cyan); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #intro-overlay h1 {
            color: var(--accent-cyan);
            font-size: 2.5rem;
            margin-bottom: 30px;
            letter-spacing: 3px;
            animation: glow 2s ease-in-out infinite;
            text-transform: uppercase;
        }
        
        #intro-overlay > p {
            max-width: 600px;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--accent-gold);
            margin-bottom: 30px;
            animation: slideIn 0.8s ease-out 0.2s both;
        }
        
        .instructions-box {
            text-align: left;
            background: var(--bg-secondary);
            padding: 30px;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 0 20px var(--border-glow), inset 0 0 20px rgba(0, 217, 255, 0.1);
            margin: 20px 0;
            max-width: 700px;
            border-radius: 4px;
            animation: slideIn 0.8s ease-out 0.4s both;
        }
        
        .instructions-box p {
            margin-bottom: 15px;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .instructions-box p:last-child {
            margin-bottom: 0;
        }
        
        .instructions-box b {
            color: var(--accent-magenta);
            font-weight: bold;
        }

        #status-bar { 
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            border-bottom: 3px solid var(--accent-cyan);
            box-shadow: 0 4px 20px var(--border-glow);
            font-size: 0.95rem;
            font-weight: bold;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        #status-bar span {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }
        
        #art-display { 
            background: var(--bg-primary);
            color: var(--accent-green);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--bg-tertiary);
            white-space: pre;
            font-size: 0.85rem;
            line-height: 1.2;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 30px rgba(6, 255, 165, 0.1);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(6, 255, 165, 0.5);
        }
        
        #display { 
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            line-height: 1.8;
            background: var(--bg-primary);
            scrollbar-width: thin;
            scrollbar-color: var(--accent-cyan) var(--bg-secondary);
        }
        
        #display::-webkit-scrollbar {
            width: 10px;
        }
        
        #display::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        #display::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
            box-shadow: 0 0 10px var(--accent-cyan);
        }
        
        #display::-webkit-scrollbar-thumb:hover {
            background: var(--accent-green);
        }
        
        #input-area { 
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 20px 30px;
            border-top: 3px solid var(--accent-cyan);
            display: flex;
            align-items: center;
            box-shadow: 0 -4px 20px var(--border-glow);
        }
        
        #cmd-input { 
            background: transparent;
            border: none;
            color: var(--accent-cyan);
            font-family: inherit;
            font-size: 1.15rem;
            width: 100%;
            outline: none;
            margin-left: 15px;
            font-weight: bold;
        }
        
        #cmd-input::placeholder {
            color: rgba(0, 217, 255, 0.4);
        }
        
        .room-title { 
            color: var(--accent-magenta);
            font-size: 1.6rem;
            font-weight: bold;
            text-decoration: underline;
            text-decoration-color: var(--accent-gold);
            text-decoration-thickness: 2px;
            display: block;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 0, 110, 0.6);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .npc-text { 
            color: var(--accent-gold);
            font-style: italic;
            padding: 15px 20px;
            border-left: 4px solid var(--accent-gold);
            margin: 15px 0;
            background: rgba(255, 190, 11, 0.1);
            border-radius: 0 4px 4px 0;
        }
        
        .npc-name { 
            color: var(--accent-magenta);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 8px rgba(255, 0, 110, 0.5);
        }
        
        .user-cmd { 
            color: var(--accent-cyan);
            font-weight: bold;
            margin: 20px 0 8px 0;
            text-shadow: 0 0 8px rgba(0, 217, 255, 0.6);
            padding: 8px 0;
            border-top: 1px solid rgba(0, 217, 255, 0.3);
        }
        
        .user-cmd::before {
            content: '‚ñ∂ ';
            color: var(--accent-green);
            font-size: 1.2rem;
            text-shadow: 0 0 10px var(--accent-green);
        }
        
        .exit-list { 
            color: var(--accent-gold);
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            border-top: 2px solid var(--accent-cyan);
            background: rgba(255, 190, 11, 0.05);
            border-radius: 4px;
            text-shadow: 0 0 5px rgba(255, 190, 11, 0.3);
        }
        
        .exit-list::before {
            content: 'üß≠ ';
            font-size: 1.2rem;
        }
        
        .item-highlight {
            color: var(--accent-cyan);
            font-weight: bold;
            text-shadow: 0 0 8px var(--accent-cyan);
        }
        
        .btn-start { 
            background: linear-gradient(135deg, var(--accent-magenta) 0%, #d90052 100%);
            color: #fff;
            padding: 18px 45px;
            border: 2px solid var(--accent-cyan);
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.3rem;
            margin-top: 30px;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border-radius: 4px;
            animation: slideIn 0.8s ease-out 0.6s both;
        }
        
        .btn-start:hover { 
            background: linear-gradient(135deg, #ff1a7a 0%, var(--accent-magenta) 100%);
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.8), 0 6px 20px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
            animation: pulse 1s ease-in-out infinite;
        }
        
        .btn-start:active {
            transform: translateY(0);
        }
        
        .success-msg {
            color: var(--accent-green);
            font-weight: bold;
            padding: 12px 20px;
            background: rgba(6, 255, 165, 0.15);
            border: 2px solid var(--accent-green);
            border-radius: 4px;
            margin: 15px 0;
            box-shadow: 0 0 15px rgba(6, 255, 165, 0.3);
        }
        
        .error-msg {
            color: #ff5555;
            font-weight: bold;
            padding: 12px 20px;
            background: rgba(255, 85, 85, 0.15);
            border: 2px solid #ff5555;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .victory-screen {
            text-align: center;
            padding: 40px;
            animation: fadeIn 1s ease-in;
        }
        
        .victory-screen h1 {
            color: var(--accent-gold);
            font-size: 2.5rem;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite;
        }
        
        .puzzle-box {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-magenta);
            border-radius: 4px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.3);
        }
        
        .puzzle-title {
            color: var(--accent-magenta);
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .riddle-text {
            color: var(--accent-gold);
            font-style: italic;
            line-height: 1.6;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #intro-overlay h1 {
                font-size: 1.8rem;
            }
            
            #status-bar {
                justify-content: center;
            }
            
            .instructions-box {
                padding: 20px;
            }
            
            #display {
                padding: 20px;
            }
            
            .room-title {
                font-size: 1.3rem;
            }
            
            #inventory-panel {
                display: none;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="game-container">
   <div id="intro-overlay">
    <h1 id="game-title">AETHELGARD</h1>
    <p id="intro-text">Travel 20 locations to reclaim the Sun Gem from the Sorcerer Malakor.</p>
    <div class="instructions-box">
     <p>‚Ä¢ <b>NORTH, SOUTH, EAST, WEST, UP, DOWN</b> to move</p>
     <p>‚Ä¢ <b>LOOK</b> to examine your surroundings</p>
     <p>‚Ä¢ <b>TAKE [ITEM]</b> to pick something up</p>
     <p>‚Ä¢ <b>TALK [PERSON]</b> to start a conversation</p>
     <p>‚Ä¢ <b>GIVE or USE [ITEM]</b> to interact with items</p>
     <p>‚Ä¢ <b>ANSWER [TEXT]</b> to solve riddles</p>
     <p>‚Ä¢ <b>COMBINE [ITEM1] [ITEM2]</b> to create new items</p>
     <p>‚Ä¢ <b>INV</b> shows inventory (also visible in sidebar)</p>
     <p>‚Ä¢ <b>HINT</b> for humorous guidance when stuck</p>
    </div><button class="btn-start" id="start-button" onclick="startGame()">BEGIN QUEST</button>
   </div>
   <div id="status-bar"><span id="stat-loc">üìç Location: ???</span> <span id="stat-step">üö∂ Step: 1/20</span> <span id="stat-score">‚≠ê Score: 0</span>
   </div>
   <div id="main-content">
    <div id="content-wrapper">
     <div id="art-display"></div>
     <div id="display"></div>
     <div id="input-area"><span style="color:var(--accent-green); font-size: 1.3rem; text-shadow: 0 0 10px var(--accent-green);">‚ñ∂</span> <input type="text" id="cmd-input" placeholder="Enter your command..." autocomplete="off" autofocus>
     </div>
    </div>
    <div id="inventory-panel">
     <h2>üéí INVENTORY</h2>
     <div id="inventory-list">
      <div class="inventory-empty">
       No items yet
      </div>
     </div>
     <div id="map-section">
      <h2>üó∫Ô∏è MAP</h2>
      <div id="mini-map"></div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
        game_title: "AETHELGARD",
        intro_text: "Travel 20 locations to reclaim the Sun Gem from the Sorcerer Malakor.",
        start_button_text: "BEGIN QUEST",
        background_color: "#0a0e27",
        accent_color: "#00d9ff",
        highlight_color: "#ff006e",
        text_color: "#e8f4f8",
        secondary_color: "#ffbe0b"
    };

    let config = { ...defaultConfig };

    async function onConfigChange(newConfig) {
        config = { ...newConfig };
        
        const gameTitle = document.getElementById('game-title');
        const introText = document.getElementById('intro-text');
        const startButton = document.getElementById('start-button');
        
        if (gameTitle) gameTitle.textContent = config.game_title || defaultConfig.game_title;
        if (introText) introText.textContent = config.intro_text || defaultConfig.intro_text;
        if (startButton) startButton.textContent = config.start_button_text || defaultConfig.start_button_text;
        
        const root = document.documentElement;
        root.style.setProperty('--bg-primary', config.background_color || defaultConfig.background_color);
        root.style.setProperty('--accent-cyan', config.accent_color || defaultConfig.accent_color);
        root.style.setProperty('--accent-magenta', config.highlight_color || defaultConfig.highlight_color);
        root.style.setProperty('--text-primary', config.text_color || defaultConfig.text_color);
        root.style.setProperty('--accent-gold', config.secondary_color || defaultConfig.secondary_color);
    }

    function mapToCapabilities(config) {
        return {
            recolorables: [
                {
                    get: () => config.background_color || defaultConfig.background_color,
                    set: (value) => {
                        config.background_color = value;
                        window.elementSdk.setConfig({ background_color: value });
                    }
                },
                {
                    get: () => config.accent_color || defaultConfig.accent_color,
                    set: (value) => {
                        config.accent_color = value;
                        window.elementSdk.setConfig({ accent_color: value });
                    }
                },
                {
                    get: () => config.highlight_color || defaultConfig.highlight_color,
                    set: (value) => {
                        config.highlight_color = value;
                        window.elementSdk.setConfig({ highlight_color: value });
                    }
                },
                {
                    get: () => config.text_color || defaultConfig.text_color,
                    set: (value) => {
                        config.text_color = value;
                        window.elementSdk.setConfig({ text_color: value });
                    }
                },
                {
                    get: () => config.secondary_color || defaultConfig.secondary_color,
                    set: (value) => {
                        config.secondary_color = value;
                        window.elementSdk.setConfig({ secondary_color: value });
                    }
                }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
        };
    }

    function mapToEditPanelValues(config) {
        return new Map([
            ["game_title", config.game_title || defaultConfig.game_title],
            ["intro_text", config.intro_text || defaultConfig.intro_text],
            ["start_button_text", config.start_button_text || defaultConfig.start_button_text]
        ]);
    }

    if (window.elementSdk) {
        window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities,
            mapToEditPanelValues
        });
    }

    // Game Logic
    let state = { 
        current: "forest", 
        inv: [], 
        flags: {}, 
        score: 0, 
        turns: 0, 
        activeNPC: null,
        visited: new Set(["forest"]),
        moralChoices: { merciful: 0, ruthless: 0 }
    };

    const arts = {
        nature: "\n   üå≤  üå≤  üå≤   \n  / \\  / \\  / \\  \nüåø   üåø   üåø\n  ü™®     ü™®  \n    üçÉ üçÉ    ",
        town: "\n     üè∞     \n   _/ü™ü\\_    \n  |  üö™  |   \n  |______|   \n~~üåæüåæüåæüåæ~~",
        cave: "\n  /----------\\\n /  ü¶á       \\\n|    (o) (o)   |\n|       V      |\n \\____________/",
        tower: "\n     ‚ö°     \n     üóº     \n    /ü™üü™ü\\    \n   | üö™ |   \n   |_|_|_|   "
    };

    // Puzzle/riddle answers
    const puzzles = {
        sphinx: {
            question: "I speak without a mouth and hear without ears. I have no body, but come alive with wind. What am I?",
            answers: ["echo", "an echo"],
            hint: "Think about sounds bouncing back..."
        },
        runes: {
            sequence: "üåô ‚≠ê ‚òÄÔ∏è ‚≠ê üåô ‚òÄÔ∏è ?",
            answer: "star",
            answers: ["star", "‚≠ê"],
            hint: "The pattern alternates... what comes after sun?"
        }
    };

    // Item combinations
    const combinations = {
        "rope_hook": { items: ["rope", "hook"], result: "grappling_hook", msg: "üí° You tie the rope to the hook, creating a grappling hook!" },
        "torch_oil": { items: ["torch", "oil"], result: "burning_torch", msg: "üî• You soak the torch in oil. It burns brighter now!" }
    };

    const hints = {
        "forest": [
            "ü§î That shiny thing on the ground? It's not a bottle cap. Someone might want it...",
            "üí° Pro tip: Items you TAKE might be useful for NPCs who lost things. Just saying.",
            "üéØ Heading NORTH seems safer than trying to hug the trees."
        ],
        "wagon": [
            "üî® A hammer! Perfect for... hammering things. Like crates. Or rats. Especially rats in cellars.",
            "ü§∑ Village Square is NORTH. Unless you want to stare at this broken wagon all day?",
            "üí≠ Someone once said 'the right tool for the right job.' They were probably thinking of rat infestations."
        ],
        "square": [
            "üë¥ That Elder looks wise. Maybe TALK to him? Unless you prefer wandering aimlessly...",
            "üç∫ WEST leads to a tavern. NORTH goes to adventure. Choose wisely, hero.",
            "üó∫Ô∏è Three directions available. It's like a choose-your-own-adventure, except you actually have to choose."
        ],
        "tavern": [
            "üîë Locked hatches require keys. Silver ones, preferably. Know any blacksmiths?",
            "üç∫ Boran seems chatty. TALK to him about... ale? Life? Rat problems?",
            "üí° If you have the silver_key, going DOWN might reveal something bright and useful."
        ],
        "cellar": [
            "üêÄ Rats hate loud noises. And hammers. Especially hammers hitting crates.",
            "üèÆ There's definitely something glowing in here. If only those rats would leave...",
            "üí™ USE that hammer on something wooden and rat-adjacent. Physics will do the rest."
        ],
        "pass": [
            "‚öíÔ∏è This blacksmith lost something shiny and round. Ring any bells? Or coins?",
            "üóùÔ∏è Silver keys open silver locks. He has one. You have something he wants.",
            "üå≤ The maze is NORTH but it's dark. EAST leads to a mysterious gate. Choose your doom!"
        ],
        "maze_in": [
            "üïØÔ∏è It's pitch black. You're likely to be eaten by a grue. Or just trip. Get a light source!",
            "üèÆ Remember that lantern from the cellar? This is where it shines. Literally.",
            "üí° Light + Darkness = Progress. It's basic adventurer math."
        ],
        "maze_deep": [
            "üåø EAST seems mystical and glow-y. Better than staying in these creepy whispers.",
            "‚ú® Follow the light, young hero. Or just go EAST. Same thing.",
            "üßö Something magical is nearby. Probably EAST. Definitely EAST."
        ],
        "shrine": [
            "üßö The Nymph has something important. TALK to her. She won't bite. Probably.",
            "üî± The Forest Sigil is here! Just TALK and be polite. Fairies appreciate manners.",
            "üíé This is what you came for! Now you just need to figure out what to do with it..."
        ],
        "sphinx": [
            "ü¶Å This sphinx loves riddles. ANSWER correctly to proceed!",
            "üí≠ If you're stuck, try typing HINT for the riddle specifically.",
            "üß† Think about things that travel through air and bounce back..."
        ],
        "gate": [
            "üö™ Gates sealed by dark magic respond poorly to kicking. Try using magical items instead.",
            "üî± If you have a Forest Sigil, maybe USE it? Just a wild guess.",
            "‚ö° Sealed gates + Magic items = Open gates. I'm basically a genius."
        ],
        "peaks": [
            "‚ùÑÔ∏è NORTH is cold but necessary. Unless you want to admire frozen scenery forever.",
            "üßä Ice caves are NORTH. Warm clothing might be there. Or hypothermia. Adventure!",
            "‚òÉÔ∏è This is not the place to build a snowman. Keep moving NORTH."
        ],
        "ice_cave": [
            "üß• A cloak! Take it. You'll look stylish AND survive. Win-win.",
            "üì¶ Free gear lying around? What is this, a video game? (Yes. Take the cloak.)",
            "üèîÔ∏è Continue NORTH. The plot thickens. Unlike this frozen air."
        ],
        "chasm": [
            "üåâ Ice bridges are sketchy but necessary. NORTH is the only way.",
            "‚ùÑÔ∏è Don't look down. Just go NORTH. Trust the ice. Or don't. But go NORTH.",
            "üßä This bridge looks 100% safe and not at all terrifying. Proceed NORTH!"
        ],
        "hut": [
            "üßô Hermits know things. Secret things. Ale-related things. TALK to him!",
            "üç∫ He mentions ale. Boran has ale. Connect the dots, genius.",
            "üó∫Ô∏è You'll need to backtrack to the tavern eventually. But TALK to the Hermit first!"
        ],
        "bridge": [
            "üç∫ Invisible bridges need magical ale. It's in the rulebook. I checked.",
            "üëÄ Can't see a bridge? Pour some Dragon-Fire Ale! What could go wrong?",
            "üåâ USE that ale you got from Boran. Unless you enjoy staring into abysses."
        ],
        "citadel": [
            "üè∞ The final dungeon approaches! NORTH to glory! Or doom. Probably both.",
            "‚öîÔ∏è This is it. The endgame. NORTH leads to Malakor. Ready?",
            "üó°Ô∏è Turn back now or go NORTH. Just kidding, you've come too far to quit!"
        ],
        "hall": [
            "üìö WEST has books. NORTH has the boss. Choose your preferred danger level.",
            "üìú Libraries contain knowledge. And scrolls. Probably important scrolls. Just saying.",
            "üéØ Explore WEST before NORTH. Trust me. It's an RPG thing."
        ],
        "library": [
            "üìú That glowing scroll? TAKE it. It's not a trap. Probably. Definitely take it.",
            "‚ú® Ancient scrolls defeat ancient evils. It's like... thematically perfect. TAKE it!",
            "üìñ This isn't a library fine situation. The scroll is FREE. TAKE it!"
        ],
        "ante": [
            "‚ö´ NORTH is the final boss. Do you have a magical scroll? You'd better have a magical scroll.",
            "üó°Ô∏è Boss fights require preparation. Check your inventory. Got that scroll from the library?",
            "üëπ Final door = Final boss. Make sure you TALKED to everyone and have the scroll!"
        ],
        "throne": [
            "üìú USE that scroll on Malakor! It's your only hope, young adventurer!",
            "‚öîÔ∏è Talking won't work. Magic will. USE the scroll and save the world!",
            "üåü The Sun Gem is SO CLOSE. TALK to Malakor, then USE your scroll. End this!"
        ]
    };

    const world = {
        "forest": { 
            step: 1, title: "Forest Edge", art: arts.nature, 
            exits: { north: "wagon" }, 
            items: ["coin"], 
            desc: () => "Misty woods. " + (world.forest.items.includes("coin") ? "A ‚ú® <b>coin</b> glints." : "The grass is trampled.") 
        },
        "wagon": { 
            step: 2, title: "Ruined Wagon", art: arts.nature, 
            exits: { south: "forest", north: "square" }, 
            items: ["hammer"], 
            desc: "A broken cart. A üî® <b>hammer</b> lies here." 
        },
        "square": { 
            step: 3, title: "Village Square", art: arts.town, 
            exits: { south: "wagon", west: "tavern", north: "pass" }, 
            desc: "The center of Oakhaven. An üë¥ <b>Elder</b> is here.", 
            npcs: { 
                "elder": { 
                    name: "Elder Haim", 
                    intro: "Greetings, traveler.", 
                    dialogue: { 
                        root: { 
                            text: "Malakor has the Gem. You need the Forest Sigil to pass his gate.", 
                            options: [
                                {text:"Where is it?", next:"hint"}, 
                                {text:"I'll find it.", next:"exit"}
                            ]
                        }, 
                        hint: { 
                            text: "It's hidden deep in the Whispering Maze, North of here. But beware the Sphinx who guards the path!", 
                            options: [{text:"Thanks.", next:"exit"}] 
                        } 
                    } 
                } 
            } 
        },
        "tavern": { 
            step: 4, title: "Dragon Tavern", art: arts.town, 
            exits: { east: "square", down: "cellar" }, 
            condition: (d) => (d === "down" && !state.inv.includes("silver_key")) ? "üîí The cellar hatch is locked." : null, 
            desc: "Smoky pub. A hatch leads DOWN. üç∫ <b>Boran</b> the barman is here.",
            npcs: { 
                "boran": { 
                    name: "Boran", 
                    intro: "Thirsty?", 
                    dialogue: { 
                        root: { 
                            text: "My lantern is in the cellar, but it's full of rats.", 
                            options: [
                                {text:"I'll get it.", next:"exit"}, 
                                {text:"Got any ale?", next:"ale_check"}
                            ]
                        }, 
                        ale_check: { 
                            text: () => state.flags.seen_hermit ? "Since you're helping the Hermit, I'll trade ale for the Sigil." : "Not for strangers.", 
                            options: [{text:"I'll come back.", next:"exit"}] 
                        } 
                    } 
                } 
            },
            interactions: { 
                "sigil": { 
                    flag: "has_ale", 
                    get: "ale", 
                    msg: "‚úÖ Boran takes the Sigil and hands you the üç∫ <b>ale</b>." 
                } 
            } 
        },
        "cellar": { 
            step: 5, title: "The Cellar", art: arts.cave, 
            exits: { up: "tavern" }, 
            interactions: { 
                "hammer": { 
                    flag: "rats", 
                    msg: "üí• You smash a crate! Rats flee. You find a üèÆ <b>lantern</b>.", 
                    get: "lantern" 
                } 
            }, 
            desc: () => state.flags.rats ? "Safe now. A üèÆ <b>lantern</b> sits on a crate." : "üêÄ Rats hiss in the dark!" 
        },
        "pass": { 
            step: 6, title: "High Pass", art: arts.nature, 
            exits: { south: "square", north: "sphinx", east: "gate" }, 
            desc: "A rocky path. A ‚öíÔ∏è <b>Blacksmith</b> is here.",
            npcs: { 
                "smith": { 
                    name: "Ironheart", 
                    intro: "I lost my coin!", 
                    dialogue: { 
                        root: { 
                            text: "Find my silver coin and I'll give you the Silver Key.", 
                            options: [{text:"Searching...", next:"exit"}] 
                        } 
                    } 
                } 
            },
            interactions: { 
                "coin": { 
                    flag: "has_key", 
                    get: "silver_key", 
                    msg: "‚úÖ Ironheart cheers! He gives you the üîë <b>silver_key</b>." 
                } 
            } 
        },
        "sphinx": {
            step: 7, title: "Sphinx Gate", art: arts.nature,
            exits: { south: "pass", north: "maze_in" },
            condition: (d) => (d === "north" && !state.flags.sphinx_solved) ? "ü¶Å The Sphinx blocks your path. 'Answer my riddle to pass!'" : null,
            desc: () => state.flags.sphinx_solved ? "The Sphinx nods respectfully. The path NORTH is clear." : "A massive stone Sphinx guards the path. Its eyes glow with ancient wisdom.",
            puzzle: "sphinx"
        },
        "maze_in": { 
            step: 8, title: "Maze Entrance", art: arts.nature, 
            exits: { south: "sphinx", north: "maze_deep" }, 
            condition: (d) => (d === "north" && !state.inv.includes("lantern")) ? "‚ö†Ô∏è Too dark to enter." : null, 
            desc: "Thorny walls lead NORTH into darkness." 
        },
        "maze_deep": { 
            step: 9, title: "Whispering Maze", art: arts.nature, 
            exits: { south: "maze_in", east: "shrine" }, 
            desc: "Shadows twist and turn. You hear whispers." 
        },
        "shrine": { 
            step: 10, title: "Bloom Shrine", art: arts.nature, 
            exits: { west: "maze_deep" }, 
            desc: "A glowing grove. A üßö <b>Nymph</b> is here.",
            npcs: { 
                "nymph": { 
                    name: "Sariel", 
                    intro: "Welcome, brave one.", 
                    dialogue: { 
                        root: { 
                            text: "You seek the Sigil? Take it. Use it to open the Sorcerer's Gate.", 
                            options: [{text:"[TAKE SIGIL]", get: "sigil", next:"exit"}] 
                        } 
                    } 
                } 
            } 
        },
        "gate": { 
            step: 11, title: "Sorcerer's Gate", art: arts.tower, 
            exits: { west: "pass", north: "peaks" }, 
            condition: (d) => (d === "north" && !state.flags.gate) ? "üö´ The gate is sealed by dark magic." : null, 
            interactions: { 
                "sigil": { 
                    flag: "gate", 
                    msg: "‚ú® The Sigil glows! The gate rumbles open!" 
                } 
            }, 
            desc: "A massive black iron gate blocks the way north." 
        },
        "peaks": { 
            step: 12, title: "Frozen Peaks", art: arts.nature, 
            exits: { south: "gate", north: "ice_cave" }, 
            desc: "‚ùÑÔ∏è The air is freezing. Snow swirls around you." 
        },
        "ice_cave": { 
            step: 13, title: "Ice Cave", art: arts.cave, 
            exits: { south: "peaks", north: "chasm" }, 
            items: ["cloak"], 
            desc: "A frozen cavern. You find a fur üß• <b>cloak</b> here." 
        },
        "chasm": { 
            step: 14, title: "The Chasm", art: arts.nature, 
            exits: { south: "ice_cave", north: "hut" }, 
            desc: "A narrow bridge of ice spans a bottomless void." 
        },
        "hut": { 
            step: 15, title: "Hermit's Hut", art: arts.nature, 
            exits: { south: "chasm", north: "bridge" }, 
            desc: "A small shack. Smoke rises from the chimney. A üßô <b>Hermit</b> is here.", 
            npcs: { 
                "hermit": { 
                    name: "Old Hermit", 
                    intro: "Stop, traveler.", 
                    dialogue: { 
                        root: { 
                            text: "The bridge ahead is invisible. Only Dragon-Fire Ale reveals it.", 
                            options: [{text:"Where can I find it?", next:"hint"}]
                        }, 
                        hint: { 
                            text: "Boran at the Dragon Tavern has it. Tell him I sent you.", 
                            options: [{text:"I'll go now.", next:"exit"}] 
                        } 
                    } 
                } 
            } 
        },
        "bridge": { 
            step: 16, title: "The Abyss", art: arts.nature, 
            exits: { south: "hut", north: "citadel" }, 
            condition: (d) => (d === "north" && !state.flags.seen) ? "‚ö†Ô∏è There's no bridge! You'll fall!" : null, 
            interactions: { 
                "ale": { 
                    flag: "seen", 
                    msg: "üç∫ You pour the ale! A shimmering bridge materializes!" 
                } 
            }, 
            desc: "An empty void stretches before you." 
        },
        "citadel": { 
            step: 17, title: "Citadel Gate", art: arts.tower, 
            exits: { south: "bridge", north: "hall" }, 
            desc: "The dark fortress of Malakor looms above." 
        },
        "hall": { 
            step: 18, title: "Grand Hall", art: arts.tower, 
            exits: { south: "citadel", west: "library", north: "ante" }, 
            desc: "Cold stone floors. Torches flicker on the walls." 
        },
        "library": { 
            step: 19, title: "Library", art: arts.tower, 
            exits: { east: "hall" }, 
            items: ["scroll"], 
            desc: "Dusty books line the shelves. A glowing üìú <b>scroll</b> rests on a pedestal." 
        },
        "ante": { 
            step: 20, title: "Antechamber", art: arts.tower, 
            exits: { south: "hall", north: "throne" }, 
            desc: "The final door. Dark energy pulses beyond it." 
        },
        "throne": { 
            step: 21, title: "Throne Room", art: arts.tower, 
            exits: { south: "ante" }, 
            desc: () => state.flags.victory ? "üåü The Sun Gem radiates warmth! Light returns to the land!" : "‚ö´ Malakor sits on his throne, clutching the Sun Gem.",
            npcs: { 
                "malakor": { 
                    name: "Malakor the Dark", 
                    intro: "You DARE enter my domain?!", 
                    dialogue: { 
                        root: { 
                            text: "The Sun Gem is MINE! You cannot defeat me!", 
                            options: [
                                {text:"[USE SCROLL]", cond:()=>state.inv.includes("scroll"), next:"battle"}, 
                                {text:"I will stop you!", next:"exit"}
                            ] 
                        },
                        battle: {
                            text: "The scroll blazes with light! Malakor screams as his dark magic unravels. What will you do?",
                            options: [
                                {text:"[SPARE HIM] Show mercy", next:"mercy"},
                                {text:"[BANISH HIM] End this forever", next:"banish"}
                            ]
                        },
                        mercy: {
                            text: "You spare Malakor's life. He kneels, swearing to renounce darkness.",
                            options: [{text:"[Take the Gem]", next:"win_mercy"}]
                        },
                        banish: {
                            text: "You banish Malakor to the void. His screams echo into nothingness.",
                            options: [{text:"[Take the Gem]", next:"win_banish"}]
                        }
                    } 
                } 
            } 
        }
    };

    const mapLayout = `
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   THRONE(21)    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   ANTE (20)     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îê ‚îå‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇLIBRARY ‚îÇ ‚îÇ HALL  ‚îÇ
   ‚îÇ  (19)  ‚îÇ ‚îÇ (18)  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  CITADEL (17)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  BRIDGE (16)    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ    HUT (15)     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  CHASM (14)     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ ICE_CAVE (13)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  PEAKS (12)     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ PASS(6)‚îÇ ‚îÇGATE(11)‚îÇ
    ‚îî‚îÄ‚î¨‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îê ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇSPH ‚îÇ    ‚îÇSHRINE‚îÇ
  ‚îÇ(7) ‚îÇ    ‚îÇ (10) ‚îÇ
  ‚îî‚îÄ‚î¨‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îê
‚îÇMAZE_IN ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§9 ‚îÇ
‚îÇ  (8)   ‚îÇ      ‚îî‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇSQUARE  ‚îÇ
‚îÇ  (3)   ‚îÇ
‚îî‚îÄ‚î¨‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚î¥‚îê ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ2 ‚îÇ    ‚îÇTAV ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ(4) ‚îÇ
‚îî‚îÄ‚î¨‚îò    ‚îî‚îÄ‚î¨‚îÄ‚îÄ‚îò
‚îå‚îÄ‚î¥‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚î¥‚îÄ‚îÄ‚îê
‚îÇFOR ‚îÇ  ‚îÇCEL ‚îÇ
‚îÇ(1) ‚îÇ  ‚îÇ(5) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò`;

    const display = document.getElementById('display');
    const artBox = document.getElementById('art-display');
    const inputField = document.getElementById('cmd-input');
    const miniMap = document.getElementById('mini-map');

    function startGame() { 
        const overlay = document.getElementById('intro-overlay');
        overlay.style.animation = 'fadeIn 0.5s ease-out reverse';
        setTimeout(() => {
            overlay.style.display = 'none';
            render();
            updateMap();
            inputField.focus();
        }, 500);
    }

    function print(text, cls = "") {
        const p = document.createElement('p');
        if (cls) p.className = cls;
        p.innerHTML = text;
        display.appendChild(p);
        display.scrollTop = display.scrollHeight;
    }

    function updateInventoryDisplay() {
        const invList = document.getElementById('inventory-list');
        if (state.inv.length === 0) {
            invList.innerHTML = '<div class="inventory-empty">No items yet</div>';
        } else {
            invList.innerHTML = state.inv.map(item => 
                `<div class="inventory-item">üì¶ ${item.toUpperCase()}</div>`
            ).join('');
        }
    }

    function updateMap() {
        const roomNames = {
            "forest": "FOR", "wagon": "2", "square": "SQUARE", "tavern": "TAV",
            "cellar": "CEL", "pass": "PASS", "sphinx": "SPH", "maze_in": "MAZE_IN",
            "maze_deep": "9", "shrine": "SHRINE", "gate": "GATE", "peaks": "PEAKS",
            "ice_cave": "ICE_CAVE", "chasm": "CHASM", "hut": "HUT", "bridge": "BRIDGE",
            "citadel": "CITADEL", "hall": "HALL", "library": "LIBRARY", "ante": "ANTE",
            "throne": "THRONE"
        };

        let mapText = mapLayout;
        
        // Highlight current location
        const currentName = roomNames[state.current] || state.current.toUpperCase();
        const currentRegex = new RegExp(`(${currentName.replace(/[()]/g, '\\$&')})`, 'g');
        mapText = mapText.replace(currentRegex, '<span class="map-current">$1</span>');
        
        // Highlight visited locations
        state.visited.forEach(room => {
            if (room !== state.current) {
                const roomName = roomNames[room] || room.toUpperCase();
                const visitedRegex = new RegExp(`(${roomName.replace(/[()]/g, '\\$&')})`, 'g');
                mapText = mapText.replace(visitedRegex, '<span class="map-visited">$1</span>');
            }
        });
        
        miniMap.innerHTML = mapText;
    }

    function showPuzzle(puzzleKey) {
        const puzzle = puzzles[puzzleKey];
        print('<div class="puzzle-box"><div class="puzzle-title">üß© RIDDLE</div><div class="riddle-text">' + puzzle.question + '</div><div style="margin-top: 10px; color: var(--accent-cyan);">Type: ANSWER [your answer]</div></div>');
    }

    function checkPuzzleAnswer(puzzleKey, answer) {
        const puzzle = puzzles[puzzleKey];
        const normalized = answer.toLowerCase().trim();
        
        if (puzzle.answers.includes(normalized)) {
            state.flags.sphinx_solved = true;
            state.score += 50;
            print("‚úÖ The Sphinx's eyes glow brighter. 'Correct! You may pass, wise traveler.'", "success-msg");
            setTimeout(render, 1500);
            return true;
        } else {
            print("‚ùå The Sphinx shakes its head. 'Incorrect. Think harder...'", "error-msg");
            return false;
        }
    }

    function tryCombine(item1, item2) {
        const key1 = item1 + "_" + item2;
        const key2 = item2 + "_" + item1;
        
        const combo = combinations[key1] || combinations[key2];
        
        if (combo && state.inv.includes(item1) && state.inv.includes(item2)) {
            state.inv = state.inv.filter(i => i !== item1 && i !== item2);
            state.inv.push(combo.result);
            state.score += 30;
            print(combo.msg, "success-msg");
            updateInventoryDisplay();
            return true;
        } else {
            print("‚ùå Those items don't combine.", "error-msg");
            return false;
        }
    }

    function render() {
        const r = world[state.current];
        if (!r) return;
        
        display.innerHTML = "";
        artBox.innerText = r.art;
        
        print(r.title, "room-title");
        print(typeof r.desc === "function" ? r.desc() : r.desc);
        
        // Show puzzle if present
        if (r.puzzle && !state.flags[r.puzzle + "_solved"]) {
            showPuzzle(r.puzzle);
        }
        
        if (r.items?.length) print(`<span class="item-highlight">üì¶ Items: ${r.items.join(", ")}</span>`);
        
        const n = Object.keys(r.npcs || {});
        if (n.length) print(`<span class="npc-name">üë• People: ${n.join(", ").toUpperCase()}</span>`);
        
        const exits = Object.keys(r.exits).map(e => e.toUpperCase());
        print(`Available Directions: ${exits.join(", ")}`, "exit-list");
        
        document.getElementById('stat-loc').innerHTML = `üìç Location: ${r.title}`;
        document.getElementById('stat-step').innerHTML = `üö∂ Step: ${r.step}/21`;
        document.getElementById('stat-score').innerHTML = `‚≠ê Score: ${state.score}`;
        
        updateMap();
    }

    function showEnding(type) {
        let endingHTML = '<div class="victory-screen"><h1>üéâ VICTORY! üéâ</h1>';
        
        if (type === "mercy") {
            endingHTML += '<p style="color: var(--accent-cyan); font-size: 1.5rem;">You showed mercy to Malakor!</p>';
            endingHTML += '<p style="color: var(--accent-gold); font-size: 1.2rem; margin-top: 20px;">The Sun Gem is restored! Light returns to Aethelgard.</p>';
            endingHTML += '<p style="color: var(--accent-green); margin-top: 15px;">Malakor, humbled by your compassion, becomes a force for good. The realm enters an age of redemption and peace.</p>';
            endingHTML += '<p style="margin-top: 20px; color: var(--accent-magenta);">‚ú® MERCIFUL ENDING ‚ú®</p>';
        } else if (type === "banish") {
            endingHTML += '<p style="color: var(--accent-cyan); font-size: 1.5rem;">You banished Malakor forever!</p>';
            endingHTML += '<p style="color: var(--accent-gold); font-size: 1.2rem; margin-top: 20px;">The Sun Gem is restored! Light returns to Aethelgard.</p>';
            endingHTML += '<p style="color: var(--accent-green); margin-top: 15px;">With darkness vanquished completely, the realm flourishes. Your name becomes legend.</p>';
            endingHTML += '<p style="margin-top: 20px; color: var(--accent-magenta);">‚öîÔ∏è HEROIC ENDING ‚öîÔ∏è</p>';
        }
        
        endingHTML += '<p style="color: var(--accent-cyan); margin-top: 30px; font-size: 1.1rem;">Final Score: ' + state.score + ' points</p></div>';
        
        display.innerHTML = endingHTML;
    }

    function handle(raw) {
        const cmd = raw.toLowerCase().trim();
        if (!cmd) return;
        const parts = cmd.split(" ");
        const verb = parts[0];
        const room = world[state.current];

        if (state.activeNPC) {
            const choice = parseInt(cmd) - 1;
            const node = state.activeNPC.data.dialogue[state.activeNPC.node];
            if (node.options[choice]) {
                const o = node.options[choice];
                if (o.get) {
                    state.inv.push(o.get);
                    print(`‚úÖ Received: ${o.get}`, "success-msg");
                    updateInventoryDisplay();
                }
                if (o.next === "exit") { 
                    state.activeNPC = null; 
                    render(); 
                }
                else if (o.next === "win_mercy") {
                    state.flags.victory = true;
                    state.moralChoices.merciful++;
                    showEnding("mercy");
                    state.activeNPC = null;
                }
                else if (o.next === "win_banish") {
                    state.flags.victory = true;
                    state.moralChoices.ruthless++;
                    showEnding("banish");
                    state.activeNPC = null;
                }
                else { 
                    state.activeNPC.node = o.next; 
                    displayDialogue(); 
                }
            }
            return;
        }

        print(`> ${raw}`, "user-cmd");
        
        if (["north","south","east","west","up","down"].includes(verb)) {
            if (room.exits[verb]) {
                const err = room.condition ? room.condition(verb) : null;
                if (err) {
                    print(err, "error-msg");
                } else { 
                    state.current = room.exits[verb];
                    state.visited.add(state.current);
                    if(state.current === "hut") state.flags.seen_hermit = true;
                    render();
                }
            } else {
                print("‚ùå You can't go that way.", "error-msg");
            }
        }
        else if (verb === "answer") {
            const answer = parts.slice(1).join(" ");
            if (room.puzzle) {
                checkPuzzleAnswer(room.puzzle, answer);
            } else {
                print("‚ùå There's no puzzle here to answer.", "error-msg");
            }
        }
        else if (verb === "combine") {
            if (parts.length < 3) {
                print("‚ùå Usage: COMBINE [item1] [item2]", "error-msg");
            } else {
                const item1 = parts[1];
                const item2 = parts[2];
                tryCombine(item1, item2);
            }
        }
        else if (verb === "take") {
            const i = parts[parts.length-1];
            if (room.items?.includes(i)) { 
                state.inv.push(i);
                room.items = room.items.filter(x => x!==i);
                state.score += 10;
                print(`‚úÖ You take the ${i}.`, "success-msg");
                updateInventoryDisplay();
                render();
            }
            else {
                print("‚ùå You don't see that here.", "error-msg");
            }
        }
        else if (verb === "look" || verb === "l") {
            print("üîç You look around carefully...", "success-msg");
            render();
        }
        else if (verb === "hint" || verb === "h") {
            // Check if there's an active puzzle
            if (room.puzzle && !state.flags[room.puzzle + "_solved"]) {
                const puzzle = puzzles[room.puzzle];
                print(`üí° ${puzzle.hint}`, "npc-text");
            } else {
                const locationHints = hints[state.current];
                if (locationHints && locationHints.length > 0) {
                    const randomHint = locationHints[Math.floor(Math.random() * locationHints.length)];
                    print(randomHint, "npc-text");
                } else {
                    print("üí≠ You're doing great! Just... keep exploring. You got this!", "npc-text");
                }
            }
        }
        else if (verb === "talk") {
            const t = room.npcs[parts[parts.length-1]] || Object.values(room.npcs || {})[0];
            if (t) { 
                state.activeNPC = { data: t, node: "root" };
                displayDialogue();
            }
            else {
                print("‚ùå There's nobody here by that name.", "error-msg");
            }
        }
        else if (verb === "give" || verb === "use") {
            const i = state.inv.find(x => cmd.includes(x));
            const act = room.interactions?.[i];
            if (act) { 
                print(act.msg, "success-msg");
                if (act.get) {
                    state.inv.push(act.get);
                }
                if (act.flag) state.flags[act.flag] = true;
                state.inv = state.inv.filter(x => x!==i);
                state.score += 20;
                updateInventoryDisplay();
                setTimeout(render, 1500);
            }
            else {
                print("‚ùå Nothing happens.", "error-msg");
            }
        }
        else if (verb === "inv" || verb === "inventory") {
            if (state.inv.length === 0) {
                print("üéí Your inventory is empty. (Check the sidebar ‚Üí)");
            } else {
                print(`üéí You're carrying: <span class="item-highlight">${state.inv.join(", ")}</span> (See sidebar ‚Üí)`);
            }
        }
        else {
            print("‚ùå I don't understand. Try: NORTH, SOUTH, TAKE, TALK, GIVE, USE, ANSWER, COMBINE, LOOK, HINT, or INV", "error-msg");
        }
    }

    function displayDialogue() {
        const n = state.activeNPC.data;
        const node = n.dialogue[state.activeNPC.node];
        display.innerHTML = "";
        artBox.innerText = "[ üí¨ CONVERSATION ]";
        
        print(n.name, "npc-name");
        print(`"${typeof node.text === 'function' ? node.text() : node.text}"`, "npc-text");
        
        node.options.forEach((o, i) => { 
            if(!o.cond || o.cond()) {
                print(`${i + 1}. ${o.text}`, "user-cmd");
            }
        });
    }

    inputField.addEventListener('keydown', (e) => { 
        if (e.key === 'Enter') { 
            handle(inputField.value);
            inputField.value = '';
        }
    });
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b954b2d8547e0b5',t:'MTc2NzY0MDQxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
