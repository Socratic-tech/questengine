<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Aethelgard Saga</title>
    <style>
        body { background: #000; color: #55FF55; font-family: 'Courier New', monospace; display: flex; justify-content: center; margin: 0; }
        #game-container { width: 90%; max-width: 900px; padding: 20px; }
        #display { height: 500px; overflow-y: auto; border: 2px solid #555; padding: 20px; margin-bottom: 15px; background: #000; line-height: 1.6; }
        #input-area { display: flex; align-items: center; font-size: 1.2rem; border-top: 1px solid #333; padding-top: 10px; }
        #cmd-input { background: transparent; border: none; color: #FFFF55; font-family: inherit; font-size: 1.2rem; width: 100%; outline: none; margin-left: 10px; }
        .room-title { color: #FF55FF; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #555; display: block; margin-bottom: 10px; }
        .user-cmd { color: #FFFF55; margin: 10px 0; font-weight: bold; }
        .death { color: #FF5555; font-weight: bold; border: 1px solid #FF5555; padding: 10px; text-align: center; }
        .win { color: #55FFFF; font-weight: bold; text-align: center; font-size: 1.5rem; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="display"></div>
    <div id="input-area">
        <span>></span>
        <input type="text" id="cmd-input" autofocus autocomplete="off">
    </div>
</div>

<script>
/** 1. THE GAME STATE **/
let gameState = {
    currentRoom: "forest_start",
    inventory: [],
    flags: {
        bridge_fixed: false,
        beggar_fed: false,
        dragon_asleep: false,
        gate_unlocked: false,
        is_dead: false
    }
};

/** 2. THE EXPANDED WORLD (20+ STEPS) **/
const world = {
    // ACT I: THE OUTSKIRTS
    "forest_start": {
        "title": "Edge of the Whispering Woods",
        "desc": () => "The air is cold. To the NORTH is a stone bridge. To the WEST, a merchant's wagon sits abandoned.",
        "exits": { "north": "bridge_ravine", "west": "merchant_wagon" },
        "items": ["coin"]
    },
    "merchant_wagon": {
        "title": "Abandoned Wagon",
        "desc": () => "The wagon is empty except for a **hammer** left in the dirt. You can head EAST.",
        "exits": { "east": "forest_start" },
        "items": ["hammer"]
    },
    "bridge_ravine": {
        "title": "The Broken Bridge",
        "desc": () => gameState.flags.bridge_fixed ? "The bridge is repaired. You can go NORTH to the Village." : "A massive gap blocks the way NORTH. You need to repair the bridge stones. You can go SOUTH.",
        "exits": { "south": "forest_start", "north": "village_entrance" },
        "condition": (dir) => (dir === "north" && !gameState.flags.bridge_fixed) ? "The bridge is broken. You'd fall to your death!" : null,
        "interactions": { "hammer": { "flag": "bridge_fixed", "msg": "You hammer the stones into place. The bridge is sturdy!" } }
    },

    // ACT II: THE VILLAGE
    "village_entrance": {
        "title": "Village of Oakhaven",
        "desc": () => "A humble village. A hungry **beggar** sits by a fountain. Paths lead NORTH to the mountains and WEST to a Bakery.",
        "exits": { "south": "bridge_ravine", "north": "mountain_base", "west": "bakery" },
        "items": []
    },
    "bakery": {
        "title": "The Bakery",
        "desc": () => "The smell of fresh bread is divine. You could buy **bread** if you had a coin. You can go EAST.",
        "exits": { "east": "village_entrance" },
        "interactions": { "coin": { "get_item": "bread", "msg": "You trade your coin for a warm loaf of bread." } }
    },
    "mountain_base": {
        "title": "Base of Mount Krag",
        "desc": () => "The path gets steep. A large **boulder** blocks a cave to the EAST. The path continues NORTH to the castle.",
        "exits": { "south": "village_entrance", "north": "castle_gates", "east": "dark_cave" },
        "condition": (dir) => (dir === "east" && !gameState.flags.beggar_fed) ? "The boulder is too heavy to move alone. Maybe someone in town can help?" : null,
        "items": []
    },

    // ACT III: THE BRANCHING PATHS
    "dark_cave": {
        "title": "The Smuggler's Cave",
        "desc": () => "It's dark. You find a **rope** hidden here. You can go WEST.",
        "exits": { "west": "mountain_base" },
        "items": ["rope"]
    },
    "castle_gates": {
        "title": "Castle Aethelgard Gates",
        "desc": () => "Two massive guards block the way NORTH. They look bored. You can go SOUTH.",
        "exits": { "south": "mountain_base", "north": "throne_room" },
        "condition": (dir) => (dir === "north" && !gameState.flags.gate_unlocked) ? "The guards cross their halberds. 'No entry without the King's Seal!'" : null,
        "interactions": {
            "bread": { "flag": "beggar_fed", "msg": "Wait, you give the bread to the beggar instead? He tells you a secret: 'The guards love music!'" },
            "flute": { "flag": "gate_unlocked", "msg": "You play a beautiful melody. The guards fall asleep, leaving the gate open!" }
        }
    },

    // ACT IV: THE CLIMAX
    "throne_room": {
        "title": "The Throne Room",
        "desc": () => "The King sits before you. 'To prove your worth, you must bring me the **Crown** from the peaks!' NORTH to peaks.",
        "exits": { "south": "castle_gates", "north": "mountain_peaks" },
        "items": ["flute"] // You find this in the castle
    },
    "mountain_peaks": {
        "title": "The Icy Peaks",
        "desc": () => "The **crown** is on a high ledge. You'll need something to reach it. Path leads SOUTH.",
        "exits": { "south": "throne_room" },
        "interactions": {
            "rope": { "get_item": "crown", "msg": "You lasso the ledge and climb up to grab the Golden Crown!" }
        }
    },
    "victory": {
        "title": "The King's Blessing",
        "desc": () => "You return the crown. The King knights you on the spot! YOU ARE THE HERO OF AETHELGARD!",
        "exits": {},
        "win": true
    }
};

/** 3. THE ENGINE LOGIC **/
const display = document.getElementById('display');
const inputField = document.getElementById('cmd-input');

function print(text, className = "") {
    const p = document.createElement('p');
    if (className) p.className = className;
    p.innerHTML = text;
    display.appendChild(p);
    display.scrollTop = display.scrollHeight;
}

function renderScene() {
    if (gameState.is_dead) return;
    const room = world[gameState.currentRoom];
    print(`<span class="room-title">${room.title}</span>`);
    print(room.desc());
    if (room.items.length > 0) print(`Visible items: ${room.items.join(", ")}`, "system-msg");
    print(`Exits: ${Object.keys(room.exits).join(", ").toUpperCase()}`, "system-msg");
}

function handleInput(input) {
    if (gameState.is_dead) return;
    const parts = input.toLowerCase().trim().split(" ");
    const verb = parts[0];
    const noun = parts[parts.length - 1];
    const room = world[gameState.currentRoom];

    print(`> ${input}`, "user-cmd");

    if (verb === "go" || Object.keys(room.exits).includes(verb)) {
        const dir = Object.keys(room.exits).includes(verb) ? verb : noun;
        if (room.exits[dir]) {
            const error = room.condition ? room.condition(dir) : null;
            if (error) { print(error); } 
            else { 
                gameState.currentRoom = room.exits[dir]; 
                if (world[gameState.currentRoom].win) {
                    print(world[gameState.currentRoom].desc(), "win");
                    gameState.is_dead = true;
                } else {
                    renderScene();
                }
            }
        } else { print("You can't go that way."); }
    } 
    else if (verb === "take" || verb === "get") {
        if (room.items.includes(noun)) {
            gameState.inventory.push(noun);
            room.items = room.items.filter(i => i !== noun);
            print(`Taken: ${noun}.`);
        } else { print("That isn't here."); }
    } 
    else if (verb === "use") {
        if (!gameState.inventory.includes(noun)) { print(`You don't have a ${noun}.`); }
        else if (room.interactions && room.interactions[noun]) {
            const action = room.interactions[noun];
            if (action.flag) gameState.flags[action.flag] = true;
            if (action.get_item) gameState.inventory.push(action.get_item);
            print(action.msg);
            renderScene();
        } else { print("Nothing happened."); }
    }
    else if (verb === "inv") { print("Inventory: " + (gameState.inventory.length ? gameState.inventory.join(", ") : "Empty")); }
    else if (verb === "restart") { location.reload(); }
}

inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { handleInput(inputField.value); inputField.value = ''; }
});

renderScene();
</script>
</body>
</html>
