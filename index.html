<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aethelgard: The Living World</title>
    <style>
        :root { --cga-blue: #0000AA; --cga-cyan: #55FFFF; --cga-white: #FFFFFF; --cga-magenta: #FF55FF; --cga-yellow: #FFFF55; }
        body { background: #000; color: var(--cga-white); font-family: 'Courier New', monospace; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        #game-container { width: 950px; height: 100vh; display: flex; flex-direction: column; border-left: 2px solid #333; border-right: 2px solid #333; }
        
        #status-bar { background: var(--cga-blue); color: var(--cga-white); padding: 8px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--cga-white); font-size: 0.9rem; }
        #display { flex-grow: 1; overflow-y: auto; padding: 25px; line-height: 1.6; background: #050505; }
        #input-area { background: #111; padding: 20px; border-top: 2px solid var(--cga-white); display: flex; align-items: center; }
        #cmd-input { background: transparent; border: none; color: var(--cga-cyan); font-family: inherit; font-size: 1.2rem; width: 100%; outline: none; margin-left: 10px; }
        
        .room-title { color: var(--cga-magenta); font-size: 1.4rem; font-weight: bold; text-decoration: underline; margin-bottom: 15px; display: block; }
        .npc-text { color: var(--cga-yellow); font-style: italic; }
        .npc-name { color: var(--cga-magenta); font-weight: bold; }
        .system-msg { color: #888; font-size: 0.9rem; }
        .user-cmd { color: var(--cga-cyan); font-weight: bold; margin: 15px 0 5px 0; }
        .error-text { color: #FF5555; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-bar">
        <span id="stat-loc">Location: Loading...</span>
        <span id="stat-score">Score: 0</span>
        <span id="stat-step">Step: 1/20</span>
    </div>
    <div id="display"></div>
    <div id="input-area">
        <span>></span>
        <input type="text" id="cmd-input" autofocus autocomplete="off" placeholder="Talk to people or move North...">
    </div>
</div>

<script>
/** 1. DICTIONARY & SYNONYMS **/
const vocab = {
    move: ["go", "walk", "travel", "north", "south", "east", "west"],
    take: ["get", "grab", "pick", "collect"],
    talk: ["talk", "speak", "chat", "ask", "converse"],
    look: ["look", "examine", "search"]
};

/** 2. THE WORLD & NPC DATA **/
const world = {
    "forest_edge": {
        step: 1, title: "The Forest Edge",
        desc: "A misty trailhead. To the NORTH lies the Village of Oakhaven. An **old_coin** reflects the dim light.",
        exits: { north: "village_square" },
        items: ["old_coin"],
        npcs: {},
        hint: "Pick up the coin and head North to find civilization."
    },
    "village_square": {
        step: 2, title: "Oakhaven Square",
        desc: "The heart of the village. A wise **Elder** stands by the fountain. The road continues NORTH toward the mountains.",
        exits: { south: "forest_edge", north: "mountain_pass" },
        items: [],
        npcs: {
            "elder": {
                name: "Elder Haim",
                greeting: "Welcome, traveler. Our kingdom is in shadow.",
                dialogue: {
                    "shadow": "A dark sorcerer has stolen the Sun Gem. Only a hero with the Silver Key can enter his lair.",
                    "key": "The Blacksmith used to have the Silver Key, but he lost it in the forest.",
                    "coin": "That coin is old... keep it. You might need to buy passage eventually."
                }
            }
        },
        hint: "Talk to the Elder about the 'shadow' or the 'key'."
    },
    "mountain_pass": {
        step: 3, title: "The High Pass",
        desc: "The air turns cold. A rugged **Blacksmith** is searching the ground here. The path leads SOUTH or NORTH.",
        exits: { south: "village_square", north: "ice_cave" },
        npcs: {
            "blacksmith": {
                name: "Ironheart the Smith",
                greeting: "Curses! I've lost my lucky coin. I can't work without it.",
                dialogue: {
                    "key": "If you find my coin, I'll give you the Silver Key I've been hiding.",
                    "coin": "Have you seen it? It's an old silver piece."
                }
            }
        },
        interactions: {
            "old_coin": { 
                npc: "blacksmith", 
                msg: "The Smith's eyes light up! 'My coin!' He hands you a **silver_key**.", 
                get: "silver_key", 
                flag: "has_key" 
            }
        }
    }
    "rusty_anvil": {
        step: 4, title: "The Rusty Anvil Forge",
        desc: () => state.flags.has_key 
            ? "The forge is hot and bright. The Smith is busy working. A path leads SOUTH back to the pass." 
            : "The forge is cold. The Blacksmith is missing. You should check the mountain pass to the SOUTH.",
        exits: { south: "mountain_pass" },
        items: [],
        npcs: {
            "smith": {
                name: "Ironheart",
                greeting: "Thanks to you, I'm back in business!",
                dialogue: {
                    "key": "That silver key opens the cellar in the Tavern. There's something nasty down there.",
                    "tavern": "It's just West of the Village Square. Tell the Barkeeper I sent you."
                }
            }
        },
        hint: "If you have the Silver Key, head to the Tavern West of the Square."
    },
    "tavern": {
        step: 5, title: "The Sleeping Dragon Tavern",
        desc: "A rowdy tavern filled with smoke. A **Barkeeper** wipes the counter. A heavy hatch leads DOWN to the cellar. The exit is EAST.",
        exits: { east: "village_square", down: "cellar" },
        condition: (d) => (d === "down" && !state.inv.includes("silver_key")) ? "The hatch is locked with a silver padlock." : null,
        npcs: {
            "barkeeper": {
                name: "Boran",
                greeting: "Welcome! We're out of ale because of the 'rats' downstairs.",
                dialogue: {
                    "rats": "Huge things. They've taken over the cellar. I'd give anything to clear them out.",
                    "maze": "The Forest Maze to the North is impossible to navigate without a lantern. I have one in the cellar... if you can get it."
                }
            }
        },
        hint: "Talk to Boran about 'rats'. If you have the key, go DOWN."
    },
    "cellar": {
        step: 6, title: "The Dark Cellar",
        desc: () => state.flags.rats_cleared 
            ? "The cellar is quiet now. A dusty **lantern** sits on a crate. You can go UP." 
            : "Huge, red-eyed rats hiss at you! You need a weapon to clear them. You can go UP.",
        exits: { up: "tavern" },
        items: [],
        interactions: {
            "hammer": { 
                flag: "rats_cleared", 
                msg: "You swing your hammer, scaring the rats into the shadows! You find a **lantern**.", 
                get: "lantern",
                score: 15
            }
        },
        hint: "You need a 'hammer' (from the wagon in Step 1) to clear the rats."
    },
    "maze_entrance": {
        step: 7, title: "Entrance to the Whispering Maze",
        desc: "The trees here twist into unnatural shapes. To the NORTH, the maze begins. To the SOUTH is the village.",
        exits: { south: "village_square", north: "maze_center" },
        condition: (d) => (d === "north" && !state.inv.includes("lantern")) ? "It's too dark. You'd be lost forever without a light." : null,
        npcs: {},
        hint: "You must have the lantern from the Tavern Cellar to enter the maze."
    },
    "maze_center": {
        step: 8, title: "The Heart of the Maze",
        desc: "A magical clearing. A **Wood_Nymph** floats near a pedestal. The only clear path is SOUTH.",
        exits: { south: "maze_entrance" },
        items: ["forest_sigil"],
        npcs: {
            "nymph": {
                name: "Sariel",
                greeting: "Few find their way here, lantern-bearer.",
                dialogue: {
                    "sigil": "The Forest Sigil on that pedestal is required to enter the Sorcerer's Gate.",
                    "sorcerer": "He dwells in the Frozen Peak, far to the North."
                }
            }
        },
        hint: "Take the 'forest_sigil' and head back to find the path to the Frozen Peak."
    }
    // ... Additional steps (4-20) would follow this logic pattern
};

/** 3. GAME STATE **/
let state = {
    current: "forest_edge",
    inv: [],
    flags: {},
    score: 0
};

/** 4. ENGINE CORE **/
const display = document.getElementById('display');
const inputField = document.getElementById('cmd-input');

function print(text, cls = "") {
    const p = document.createElement('p');
    if (cls) p.className = cls;
    p.innerHTML = text;
    display.appendChild(p);
    display.scrollTop = display.scrollHeight;
}

function updateHUD() {
    const room = world[state.current];
    document.getElementById('stat-loc').innerText = `Location: ${room.title}`;
    document.getElementById('stat-score').innerText = `Score: ${state.score}`;
    document.getElementById('stat-step').innerText = `Step: ${room.step}/20`;
}

function render() {
    function render() {
    const room = world[state.current];
    if (room.win) { 
        print(`<div class="win">${room.title}<br>${typeof room.desc === 'function' ? room.desc() : room.desc}</div>`); 
        return; 
    }
    
    display.innerHTML = "";
    print(`<span class="room-title">${room.title}</span>`);
    
    // This line is the key tweak! 
    // It checks: "Is the description a function? If yes, run it. If no, just print it."
    const descriptionText = (typeof room.desc === "function") ? room.desc() : room.desc;
    print(descriptionText);
    
    if (room.items?.length > 0) print(`Visible Items: <span style="color:var(--cga-cyan)">${room.items.join(", ")}</span>`);
    
    const npcNames = Object.keys(room.npcs || {});
    if (npcNames.length > 0) print(`People here: <span class="npc-name">${npcNames.join(", ").toUpperCase()}</span>`);
    
    updateHUD();
}

function parseCommand(input) {
    const raw = input.toLowerCase().trim();
    const parts = raw.split(" ");
    const verb = parts[0];
    const noun = parts[parts.length - 1];
    const room = world[state.current];

    print(`> ${input}`, "user-cmd");

    // Help / Hints
    if (verb === "help" || verb === "hint") {
        print(`SYSTEM: ${room.hint}`, "system-msg");
        return;
    }

    // Movement
    if (vocab.move.includes(verb) || ["north", "south", "east", "west"].includes(verb)) {
        const dir = ["north", "south", "east", "west"].includes(verb) ? verb : noun;
        if (room.exits[dir]) {
            state.current = room.exits[dir];
            render();
        } else {
            print(`You can't go ${dir}. Try: ${Object.keys(room.exits).join(", ").toUpperCase()}`, "error-text");
        }
        return;
    }

    // NPC Interaction (Talk)
    if (vocab.talk.includes(verb)) {
        const npc = room.npcs[noun] || Object.values(room.npcs)[0];
        if (npc) {
            // Check if asking about a specific topic
            const topic = parts.find(w => npc.dialogue[w]);
            if (topic) {
                print(`<span class="npc-name">${npc.name}:</span> <span class="npc-text">"${npc.dialogue[topic]}"</span>`);
            } else {
                print(`<span class="npc-name">${npc.name}:</span> <span class="npc-text">"${npc.greeting}"</span>`);
                print(`<span class="system-msg">(Try asking about: ${Object.keys(npc.dialogue).join(", ")})</span>`);
            }
        } else {
            print("There is no one here to talk to.", "error-text");
        }
        return;
    }

    // Take Items
    if (vocab.take.includes(verb)) {
        if (room.items.includes(noun)) {
            state.inv.push(noun);
            room.items = room.items.filter(i => i !== noun);
            state.score += 5;
            print(`You picked up the ${noun}.`);
            updateHUD();
        } else {
            print(`The ${noun} isn't here.`, "error-text");
        }
        return;
    }

    // Use Items
    if (verb === "use" || verb === "give") {
        if (state.inv.includes(noun)) {
            const interact = room.interactions?.[noun];
            if (interact) {
                print(interact.msg);
                if (interact.get) state.inv.push(interact.get);
                if (interact.flag) state.flags[interact.flag] = true;
                state.score += 10;
                state.inv = state.inv.filter(i => i !== noun); // Consume item
                updateHUD();
            } else {
                print("Nothing happened.");
            }
        } else {
            print(`You don't have a ${noun}.`, "error-text");
        }
        return;
    }

    // Inventory
    if (verb === "inv" || verb === "inventory") {
        print(`Carrying: ${state.inv.length ? state.inv.join(", ") : "Nothing"}`);
        return;
    }

    print(`I don't know how to '${verb}'. Type 'HELP' for assistance.`, "error-text");
}

inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        parseCommand(inputField.value);
        inputField.value = '';
    }
});

// Start
render();
print("<b>AETHELGARD ONLINE.</b> Type 'TALK TO ELDER' to begin.", "system-msg");
</script>
</body>
</html>
