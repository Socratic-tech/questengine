<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aethelgard: The Complete Saga</title>
    <style>
        :root { 
            --cga-blue: #0000AA; --cga-cyan: #55FFFF; --cga-white: #FFFFFF; 
            --cga-magenta: #FF55FF; --cga-yellow: #FFFF55; --cga-red: #FF5555;
        }
        body { background: #000; color: var(--cga-white); font-family: 'Courier New', monospace; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        #game-container { width: 100%; max-width: 900px; height: 100vh; display: flex; flex-direction: column; border-left: 2px solid #333; border-right: 2px solid #333; }
        #status-bar { background: var(--cga-blue); color: var(--cga-white); padding: 8px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--cga-white); font-size: 0.8rem; }
        #art-display { background: #000; color: var(--cga-cyan); padding: 10px; text-align: center; border-bottom: 1px solid #222; white-space: pre; font-size: 0.7rem; line-height: 1.1; height: 140px; }
        #display { flex-grow: 1; overflow-y: auto; padding: 20px; line-height: 1.5; background: #050505; }
        #input-area { background: #111; padding: 15px; border-top: 2px solid var(--cga-white); display: flex; align-items: center; }
        #cmd-input { background: transparent; border: none; color: var(--cga-cyan); font-family: inherit; font-size: 1.1rem; width: 100%; outline: none; margin-left: 10px; }
        .room-title { color: var(--cga-magenta); font-size: 1.3rem; font-weight: bold; text-decoration: underline; display: block; }
        .npc-text { color: var(--cga-yellow); font-style: italic; }
        .npc-name { color: var(--cga-magenta); font-weight: bold; }
        .user-cmd { color: var(--cga-cyan); font-weight: bold; margin: 10px 0 2px 0; }
        .flavor-text { color: #555; font-size: 0.85rem; font-style: italic; margin: 10px 0; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-bar">
        <span id="stat-loc">Location: ???</span>
        <span id="stat-step">Step: 1/20</span>
        <span id="stat-score">Score: 0</span>
    </div>
    <div id="art-display"></div>
    <div id="display"></div>
    <div id="input-area">
        <span style="color:var(--cga-cyan)">â–¶</span>
        <input type="text" id="cmd-input" autofocus>
    </div>
</div>

<script>
/** 1. DATA **/
let state = { current: "forest", inv: [], flags: {}, score: 0, turns: 0, activeNPC: null };

const arts = {
    nature: "\n   ^  ^  ^   \n  / \\/ \\/ \\  \n /   \\  /  \\ \n/_   _\\/_   _\\\n  | |    | |  ",
    town: "\n     _L_     \n   _/__\\_    \n  |      |   \n  |  []  |   \n~~|______|~~~",
    tower: "\n     [|]     \n     | |     \n    /   \\    \n   |     |   \n   |_|_|_|   "
};

const world = {
    "forest": {
        step: 1, title: "The Forest Edge", art: arts.nature,
        desc: () => "A misty trailhead. " + (world.forest.items.includes("coin") ? "A shiny **coin** is here." : "") + " WEST to a wagon, NORTH to Oakhaven.",
        exits: { north: "square", west: "wagon" }, items: ["coin"]
    },
    "wagon": {
        step: 2, title: "Ruined Wagon", art: arts.nature,
        desc: () => "A broken cart. " + (world.wagon.items.includes("hammer") ? "A **hammer** lies in the mud." : ""),
        exits: { east: "forest" }, items: ["hammer"]
    },
    "square": {
        step: 3, title: "Oakhaven Square", art: arts.town,
        desc: "The village center. An **Elder** is here. NORTH to mountains, WEST to Tavern.",
        exits: { south: "forest", north: "pass", west: "tavern" },
        npcs: { "elder": { name: "Elder Haim", intro: "The Sun Gem is missing...", dialogue: { root: { text: "Malakor took it to the Frozen Peaks. You'll need a Sigil to pass.", options: [{text:"I'll find it.", next:"exit"}] } } } }
    },
    "pass": {
        step: 4, title: "The High Pass", art: arts.nature,
        desc: () => state.flags.has_key ? "The Blacksmith is happy." : "A **Blacksmith** is looking for his coin.",
        exits: { south: "square", north: "gate" },
        npcs: { "blacksmith": { name: "Ironheart", intro: "Where is my coin?", dialogue: { root: { text: "Find it and the Silver Key is yours.", options: [{text:"Searching!", next:"exit"}] } } } },
        interactions: { "coin": { npc: "blacksmith", msg: "He gives you the **silver_key**!", get: "silver_key", flag: "has_key" } }
    },
    "tavern": {
        step: 5, title: "Sleeping Dragon Tavern", art: arts.town,
        desc: "A warm pub. A hatch leads DOWN. EAST to square.",
        exits: { east: "square", down: "cellar" },
        condition: (d) => (d === "down" && !state.inv.includes("silver_key")) ? "Locked." : null,
        npcs: { "barman": { name: "Boran", intro: "Check the cellar.", dialogue: { root: { text: "The lantern is down there, past the rats.", options: [{text:"On it.", next:"exit"}] } } } }
    },
    "cellar": {
        step: 6, title: "The Cellar", art: arts.town,
        desc: () => state.flags.rats ? "The rats are gone. A **lantern** is here." : "Rats block the way! Use a tool. UP to exit.",
        exits: { up: "tavern" },
        interactions: { "hammer": { flag: "rats", msg: "You clear the rats! You find a **lantern**.", get: "lantern" } }
    },
    "maze": {
        step: 8, title: "Whispering Maze", art: arts.nature,
        desc: "A foggy maze. A **Nymph** guards the center. SOUTH to Oakhaven.",
        exits: { south: "square", north: "gate" },
        condition: (d) => (d === "north" && !state.inv.includes("lantern")) ? "Too dark." : null,
        npcs: { "nymph": { name: "Sariel", intro: "I guard the Sigil.", dialogue: { root: { text: "The sun must return. Take this.", options: [{text:"[TAKE SIGIL]", next:"exit", get:"sigil"}] } } } }
    },
    "gate": {
        step: 10, title: "Sorcerer's Gate", art: arts.tower,
        desc: () => state.flags.gate ? "The gate is open to the NORTH." : "A massive gate blocks the NORTH.",
        exits: { south: "pass", north: "peaks" },
        condition: (d) => (d === "north" && !state.flags.gate) ? "It's sealed." : null,
        interactions: { "sigil": { flag: "gate", msg: "The gate opens!" } }
    },
    "peaks": {
        step: 15, title: "Frozen Peaks", art: arts.nature,
        desc: "A blizzard. A chasm is NORTH. A **Hermit** huddles by a fire.",
        exits: { south: "gate", north: "throne" },
        npcs: { "hermit": { name: "Hermit", intro: "Drink 'ale' to see the bridge.", dialogue: { root: { text: "Boran at the Tavern has the Dragon-Fire Ale.", options: [{text:"I'll go back.", next:"exit"}] } } } }
    },
    "throne": {
        step: 20, title: "Throne of Shadow", art: arts.tower,
        desc: "Malakor stands here.",
        npcs: { "malakor": { name: "Malakor", intro: "You die now.", dialogue: { root: { text: "Surrender!", options: [{text:"[USE SCROLL]", next:"win", cond:()=>state.inv.includes("scroll")}] } } } }
    }
};

/** 2. ENGINE **/
const display = document.getElementById('display');
const artBox = document.getElementById('art-display');
const inputField = document.getElementById('cmd-input');

function print(text, cls = "") {
    const p = document.createElement('p'); if (cls) p.className = cls;
    p.innerHTML = text; display.appendChild(p);
    display.scrollTop = display.scrollHeight;
}

function updateHUD() {
    const r = world[state.current];
    document.getElementById('stat-loc').innerText = `Location: ${r.title}`;
    document.getElementById('stat-step').innerText = `Step: ${r.step}/20`;
    document.getElementById('stat-score').innerText = `Score: ${state.score}`;
}

function render() {
    const r = world[state.current];
    display.innerHTML = "";
    artBox.innerText = r.art;
    print(r.title, "room-title");
    print(typeof r.desc === "function" ? r.desc() : r.desc);
    if (r.items?.length) print(`Items: <span style="color:var(--cga-cyan)">${r.items.join(", ")}</span>`);
    const n = Object.keys(r.npcs || {});
    if (n.length) print(`People: <span class="npc-name">${n.join(", ").toUpperCase()}</span>`);
    if (state.turns % 5 === 0 && state.turns > 0) print("The air feels colder...", "flavor-text");
    updateHUD();
}

function handle(raw) {
    const cmd = raw.toLowerCase().trim();
    const parts = cmd.split(" ");
    const verb = parts[0];
    const room = world[state.current];

    if (state.activeNPC) {
        const choice = parseInt(cmd) - 1;
        const node = state.activeNPC.data.dialogue[state.activeNPC.node];
        if (node.options[choice]) {
            const o = node.options[choice];
            if (o.get) state.inv.push(o.get);
            if (o.next === "exit") { state.activeNPC = null; render(); }
            else if (o.next === "win") { display.innerHTML = "<h1>VICTORY</h1>"; state.current="forest"; }
            else { state.activeNPC.node = o.next; displayDialogue(); }
        }
        return;
    }

    state.turns++;
    print(`> ${raw}`, "user-cmd");

    if (["north","south","east","west","up","down"].includes(verb)) {
        if (room.exits[verb]) {
            const err = room.condition ? room.condition(verb) : null;
            if (err) print(err, "error-text");
            else { state.current = room.exits[verb]; render(); }
        } else print("Blocked.");
    } 
    else if (verb === "talk") {
        const t = room.npcs[parts[parts.length-1]] || Object.values(room.npcs || {})[0];
        if (t) { state.activeNPC = { data: t, node: "root" }; displayDialogue(); }
        else print("No one here.");
    }
    else if (verb === "take") {
        const i = parts[parts.length-1];
        if (room.items?.includes(i)) { state.inv.push(i); room.items = room.items.filter(x => x!==i); print(`Got ${i}.`); updateHUD(); }
        else print("Not here.");
    }
    else if (verb === "use" || verb === "give") {
        const i = state.inv.find(x => cmd.includes(x));
        const act = room.interactions?.[i];
        if (act) {
            print(act.msg, "npc-text");
            if (act.get) state.inv.push(act.get);
            if (act.flag) state.flags[act.flag] = true;
            state.inv = state.inv.filter(x => x!==i);
            state.score += 20; render();
        } else print("Nothing happens.");
    }
    else if (verb === "inv") print("Inv: " + (state.inv.join(", ") || "Empty"));
}

function displayDialogue() {
    const n = state.activeNPC.data;
    const node = n.dialogue[state.activeNPC.node];
    display.innerHTML = "";
    print(n.name, "npc-name");
    print(`"${node.text}"`, "npc-text");
    node.options.forEach((o, i) => print(`${i + 1}. ${o.text}`, "user-cmd"));
}

window.onload = () => { render(); inputField.focus(); };
inputField.addEventListener('keydown', (e) => { if (e.key === 'Enter') { handle(inputField.value); inputField.value = ''; } });
</script>
</body>
</html>
