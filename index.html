<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aethelgard: Hero's Quest</title>
    <style>
        :root { --cga-blue: #0000AA; --cga-cyan: #55FFFF; --cga-white: #FFFFFF; --cga-magenta: #FF55FF; --cga-yellow: #FFFF55; }
        body { background: #000; color: var(--cga-white); font-family: 'Courier New', monospace; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        #game-container { width: 100%; max-width: 900px; height: 100vh; display: flex; flex-direction: column; border-left: 2px solid #333; border-right: 2px solid #333; }
        #status-bar { background: var(--cga-blue); color: var(--cga-white); padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--cga-white); font-size: 0.9rem; }
        #display { flex-grow: 1; overflow-y: auto; padding: 25px; line-height: 1.6; background: #050505; }
        #input-area { background: #111; padding: 20px; border-top: 2px solid var(--cga-white); display: flex; align-items: center; }
        #cmd-input { background: transparent; border: none; color: var(--cga-cyan); font-family: inherit; font-size: 1.2rem; width: 100%; outline: none; margin-left: 10px; }
        .room-title { color: var(--cga-magenta); font-size: 1.4rem; font-weight: bold; text-decoration: underline; margin-bottom: 10px; display: block; }
        .npc-text { color: var(--cga-yellow); font-style: italic; }
        .npc-name { color: var(--cga-magenta); font-weight: bold; }
        .user-cmd { color: var(--cga-cyan); font-weight: bold; margin: 15px 0 5px 0; }
        .error-text { color: #FF5555; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-bar">
        <span id="stat-loc">Location: Initializing...</span>
        <span id="stat-score">Score: 0</span>
        <span id="stat-step">Step: 1/20</span>
    </div>
    <div id="display"><p>Booting Aethelgard Engine...</p></div>
    <div id="input-area">
        <span>></span>
        <input type="text" id="cmd-input" autofocus autocomplete="off">
    </div>
</div>

<script>
/** 1. GAME STATE **/
let state = {
    current: "forest_start",
    inv: [],
    flags: { rats_cleared: false, has_key: false },
    score: 0
};

/** 2. THE WORLD DATA (STEPS 1-8) **/
const world = {
    "forest_start": {
        step: 1, title: "The Forest Edge",
        desc: "You stand at a misty trailhead. To the WEST is a broken merchant wagon. To the NORTH lies a village.",
        exits: { north: "village_square", west: "wagon" },
        items: ["old_coin"],
        npcs: {},
        hint: "Check the wagon to the WEST or take the coin and head NORTH."
    },
    "wagon": {
        step: 1, title: "The Broken Wagon",
        desc: "The merchant fled long ago. A **hammer** lies in the dirt. Path leads EAST.",
        exits: { east: "forest_start" },
        items: ["hammer"],
        npcs: {},
        hint: "TAKE the hammer. You will need it to clear obstacles later."
    },
    "village_square": {
        step: 2, title: "Oakhaven Village Square",
        desc: "The heart of the village. An **Elder** stands by the fountain. Paths lead NORTH to mountains and WEST to a Tavern.",
        exits: { south: "forest_start", north: "mountain_pass", west: "tavern" },
        items: [],
        npcs: {
            "elder": {
                name: "Elder Haim",
                greeting: "Welcome! The kingdom is in shadow. We need a hero.",
                dialogue: {
                    "shadow": "A sorcerer stole our Sun Gem. The way is blocked by a magic gate.",
                    "gate": "You need a Forest Sigil. Sariel in the Whispering Maze might have it.",
                    "key": "The Blacksmith lost the Silver Key near the mountains."
                }
            }
        },
        hint: "Talk to the Elder about the 'key' or head NORTH to the mountains."
    },
    "mountain_pass": {
        step: 3, title: "The High Pass",
        desc: "Cold wind howls. A **Blacksmith** is searching the ground. Path leads SOUTH or NORTH.",
        exits: { south: "village_square", north: "rusty_anvil" },
        npcs: {
            "blacksmith": {
                name: "Ironheart",
                greeting: "I lost my lucky silver coin! I can't work without it.",
                dialogue: { "coin": "It's an old silver piece. I dropped it near the forest entrance." }
            }
        },
        interactions: {
            "old_coin": { npc: "blacksmith", msg: "Ironheart cheers! 'My coin!' He hands you a **silver_key**.", get: "silver_key", flag: "has_key" }
        },
        hint: "GIVE the coin to the Blacksmith to get the key."
    },
    "rusty_anvil": {
        step: 4, title: "The Forge",
        desc: "The anvil is ready. The road leads SOUTH.",
        exits: { south: "mountain_pass" },
        items: [],
        npcs: { "smith": { name: "Ironheart", greeting: "Use that key in the Tavern cellar!", dialogue: {} } },
        hint: "Go back to the Village and then WEST to the Tavern."
    },
    "tavern": {
        step: 5, title: "The Sleeping Dragon Tavern",
        desc: "Smoky and loud. A heavy hatch leads DOWN to the cellar. Exit EAST.",
        exits: { east: "village_square", down: "cellar" },
        condition: (d) => (d === "down" && !state.inv.includes("silver_key")) ? "The hatch is locked tight." : null,
        npcs: { "barman": { name: "Boran", greeting: "The cellar is full of rats. I can't get my lantern.", dialogue: {} } },
        hint: "If you have the key, go DOWN into the cellar."
    },
    "cellar": {
        step: 6, title: "The Dark Cellar",
        desc: () => state.flags.rats_cleared ? "The rats are gone. A **lantern** is here. Go UP." : "Huge rats block the way! You need a tool to scare them. Go UP.",
        exits: { up: "tavern" },
        items: [],
        interactions: {
            "hammer": { flag: "rats_cleared", msg: "You swing the hammer! The rats flee. You find a **lantern**.", get: "lantern" }
        },
        hint: "USE the hammer from the wagon to clear the rats."
    },
    "maze_entrance": {
        step: 7, title: "Maze Entrance",
        desc: "Thick fog to the NORTH. South to the Village.",
        exits: { south: "village_square", north: "maze_center" },
        condition: (d) => (d === "north" && !state.inv.includes("lantern")) ? "Too dark! You need a light." : null,
        npcs: {},
        hint: "You need the lantern from the cellar to enter the maze."
    },
    "maze_center": {
        step: 8, title: "Heart of the Maze",
        desc: "A magical glade. A **nymph** guards a **sigil**. Path leads SOUTH.",
        exits: { south: "maze_entrance" },
        items: ["sigil"],
        npcs: { "nymph": { name: "Sariel", greeting: "The forest greets you.", dialogue: {} } },
        hint: "TAKE the sigil. This is your ticket to the final act!"
    }
};

/** 3. ENGINE LOGIC **/
const display = document.getElementById('display');
const inputField = document.getElementById('cmd-input');

function print(text, cls = "") {
    const p = document.createElement('p');
    if (cls) p.className = cls;
    p.innerHTML = text;
    display.appendChild(p);
    display.scrollTop = display.scrollHeight;
}

function updateHUD() {
    const room = world[state.current];
    if (!room) return;
    document.getElementById('stat-loc').innerText = `Location: ${room.title}`;
    document.getElementById('stat-score').innerText = `Score: ${state.score}`;
    document.getElementById('stat-step').innerText = `Step: ${room.step}/20`;
}

function render() {
    const room = world[state.current];
    if (!room) { print("Error: Room not found!", "error-text"); return; }
    
    display.innerHTML = "";
    print(room.title, "room-title");
    
    // Support for dynamic descriptions
    const d = (typeof room.desc === "function") ? room.desc() : room.desc;
    print(d);
    
    if (room.items?.length > 0) print(`Items: <span style="color:var(--cga-cyan)">${room.items.join(", ")}</span>`);
    
    const npcs = Object.keys(room.npcs || {});
    if (npcs.length > 0) print(`People: <span class="npc-name">${npcs.join(", ").toUpperCase()}</span>`);
    
    updateHUD();
}

function handle(raw) {
    const input = raw.toLowerCase().trim();
    const parts = input.split(" ");
    const verb = parts[0];
    const noun = parts[parts.length - 1];
    const room = world[state.current];

    print(`> ${raw}`, "user-cmd");

    if (verb === "help" || verb === "hint") {
        print(`HINT: ${room.hint}`, "npc-text");
    } 
    else if (["north", "south", "east", "west", "up", "down", "go"].includes(verb)) {
        const dir = (verb === "go") ? noun : verb;
        if (room.exits[dir]) {
            const err = room.condition ? room.condition(dir) : null;
            if (err) print(err, "error-text");
            else { state.current = room.exits[dir]; render(); }
        } else print("You can't go that way.", "error-text");
    }
    else if (verb === "take" || verb === "get") {
        if (room.items.includes(noun)) {
            state.inv.push(noun);
            room.items = room.items.filter(i => i !== noun);
            print(`Took ${noun}.`);
            updateHUD();
        } else print("Nothing to take.", "error-text");
    }
    else if (verb === "talk" || verb === "ask") {
        const npc = room.npcs[noun] || Object.values(room.npcs)[0];
        if (npc) {
            const topic = parts.find(p => npc.dialogue[p]);
            if (topic) print(`${npc.name}: "${npc.dialogue[topic]}"`, "npc-text");
            else print(`${npc.name}: "${npc.greeting}"`, "npc-text");
        } else print("No one to talk to.", "error-text");
    }
    else if (verb === "use" || verb === "give") {
        if (state.inv.includes(noun)) {
            const action = room.interactions?.[noun];
            if (action) {
                print(action.msg);
                if (action.get) state.inv.push(action.get);
                if (action.flag) state.flags[action.flag] = true;
                state.inv = state.inv.filter(i => i !== noun);
                state.score += 10;
                render();
            } else print("Nothing happened.");
        } else print("You don't have that.", "error-text");
    }
    else if (verb === "inv") print("Inv: " + (state.inv.join(", ") || "Empty"));
}

// SAFE INITIALIZATION
window.onload = () => {
    try {
        render();
        print("<b>System Online.</b> Try 'WEST' to see the wagon or 'TAKE COIN'.", "npc-text");
        inputField.focus();
    } catch(e) {
        document.getElementById('display').innerHTML = `<p class="error-text">Engine Crash: ${e.message}</p>`;
    }
};

inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { handle(inputField.value); inputField.value = ''; }
});
</script>
</body>
</html>
