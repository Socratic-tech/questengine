<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aethelgard: The Hero's Fate</title>
    <style>
        :root { 
            --cga-blue: #0000AA; --cga-cyan: #55FFFF; --cga-white: #FFFFFF; 
            --cga-magenta: #FF55FF; --cga-yellow: #FFFF55; --cga-red: #FF5555;
        }
        body { background: #000; color: var(--cga-white); font-family: 'Courier New', monospace; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        #game-container { width: 100%; max-width: 900px; height: 100vh; display: flex; flex-direction: column; border-left: 2px solid #333; border-right: 2px solid #333; position: relative; }
        
        /* Intro Overlay */
        #intro-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding: 20px; box-sizing: border-box; border: 4px double var(--cga-magenta); }
        
        #status-bar { background: var(--cga-blue); color: var(--cga-white); padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--cga-white); font-size: 0.85rem; }
        #display { flex-grow: 1; overflow-y: auto; padding: 25px; line-height: 1.6; background: #050505; }
        #input-area { background: #111; padding: 20px; border-top: 2px solid var(--cga-white); display: flex; align-items: center; }
        #cmd-input { background: transparent; border: none; color: var(--cga-cyan); font-family: inherit; font-size: 1.2rem; width: 100%; outline: none; margin-left: 10px; }
        
        .room-title { color: var(--cga-magenta); font-size: 1.4rem; font-weight: bold; text-decoration: underline; margin-bottom: 10px; display: block; }
        .npc-text { color: var(--cga-yellow); font-style: italic; }
        .npc-name { color: var(--cga-magenta); font-weight: bold; }
        .user-cmd { color: var(--cga-cyan); font-weight: bold; margin: 15px 0 5px 0; }
        .error-text { color: var(--cga-red); font-weight: bold; }
        .sys-note { color: #888; font-size: 0.9rem; }
        .btn { background: var(--cga-magenta); color: #000; padding: 10px 20px; border: none; cursor: pointer; font-family: inherit; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="intro-overlay">
        <h1 style="color:var(--cga-cyan)">AETHELGARD: THE HERO'S FATE</h1>
        <p>The Sun Gem is missing. The world is falling into shadow.</p>
        <div style="text-align:left; background:#111; padding:15px; border:1px solid #444;">
            <p>• <b>GO [NORTH/SOUTH/etc]</b> to move.</p>
            <p>• <b>TALK [NAME]</b> to start a conversation.</p>
            <p>• <b>TAKE [ITEM]</b> to collect things.</p>
            <p>• <b>USE [ITEM]</b> to interact with the world.</p>
            <p>• <b>INV</b> to check your items.</p>
        </div>
        <button class="btn" onclick="startGame()">ENTER THE REALM</button>
    </div>

    <div id="status-bar">
        <span id="stat-loc">Location: ???</span>
        <span id="stat-align">Moral: Neutral</span>
        <span id="stat-step">Step: 1/20</span>
    </div>
    <div id="display"></div>
    <div id="input-area">
        <span>></span>
        <input type="text" id="cmd-input" autocomplete="off">
    </div>
</div>

<script>
/** 1. DATA & WORLD **/
let state = {
    current: "forest_start",
    inv: [],
    flags: { rats_cleared: false, has_key: false, gate_open: false, bridge_visible: false, sorcerer_defeated: false },
    alignment: 0, // Negative for Ruthless, Positive for Heroic
    activeNPC: null,
    gameActive: false
};

const world = {
    "forest_start": { step: 1, title: "The Forest Edge", desc: "A misty trailhead. To the WEST is a broken merchant wagon. NORTH to the village.", exits: { north: "village_square", west: "wagon" }, items: ["coin"], npcs: {}, hint: "Take the coin and go West to the wagon." },
    "wagon": { step: 2, title: "The Merchant's Ruin", desc: "A splintered cart. A heavy **hammer** lies in the mud. Go EAST.", exits: { east: "forest_start" }, items: ["hammer"], npcs: {}, hint: "Take the hammer; you will need it for obstacles." },
    "village_square": { step: 3, title: "Oakhaven Square", desc: "The village heart. An **Elder** sits by a dry fountain. NORTH to mountains, WEST to a Tavern.", exits: { south: "forest_start", north: "mountain_pass", west: "tavern" }, items: [], 
        npcs: { 
            "elder": { name: "Elder Haim", intro: "A traveler! Come, let us speak of the shadow.", 
            dialogue: { 
                root: { text: "The Sun Gem is gone. Will you help us find it?", options: [{text:"I will be your hero.", next:"hero", align:2}, {text:"If the reward is high enough.", next:"merc", align:-2}] },
                hero: { text: "Noble spirit! Talk to the Blacksmith in the pass. He knows the way.", options: [{text:"I'm on my way.", next:"exit"}] },
                merc: { text: "Gold is scarce, but your life is worth more than coins. Talk to the Blacksmith.", options: [{text:"I'll see what he has.", next:"exit"}] }
            }} 
        } 
    },
    "mountain_pass": { step: 4, title: "The Mountain Pass", desc: "A rocky path. A **Blacksmith** is searching the dirt. NORTH to the peaks, SOUTH to village.", exits: { south: "village_square", north: "sorcerer_gate" }, items: [], 
        npcs: {
            "blacksmith": { name: "Ironheart", intro: "Curses! I've lost my silver coin!", 
            dialogue: {
                root: { text: "I can't work without my lucky coin. It's somewhere near the forest edge.", options: [{text:"I'll find it for you.", next:"exit"}] }
            }}
        },
        interactions: { "coin": { npc: "blacksmith", msg: "He gives you a **silver_key**! 'This opens the tavern cellar.'", get: "silver_key", flag: "has_key" } }
    },
    "tavern": { step: 5, title: "Sleeping Dragon Tavern", desc: "Smoky and dim. A **Barman** wipes the counter. A hatch leads DOWN. EAST to square.", exits: { east: "village_square", down: "cellar" }, 
        condition: (d) => (d === "down" && !state.inv.includes("silver_key")) ? "The hatch is locked with a silver padlock." : null,
        npcs: {
            "barman": { name: "Boran", intro: "Watch your step. The cellar is infested.", 
            dialogue: {
                root: { text: "The rats are huge. My lantern is down there, but I'm not going in.", options: [{text:"I'll clear them out.", next:"exit"}] }
            }}
        }
    },
    "cellar": { step: 6, title: "The Rat-Filled Cellar", desc: () => state.flags.rats_cleared ? "The rats are gone. A **lantern** is here. Go UP." : "Hissing rats block the way! You need a tool to scare them. Go UP.", exits: { up: "tavern" }, items: [],
        interactions: { "hammer": { flag: "rats_cleared", msg: "You smash the crates! The rats flee. You grab the **lantern**.", get: "lantern" } }
    },
    "maze_entrance": { step: 7, title: "The Whispering Maze", desc: "North of the square. Thick fog leads NORTH into the maze.", exits: { south: "village_square", north: "maze_center" },
        condition: (d) => (d === "north" && !state.inv.includes("lantern")) ? "It's too dark to enter." : null
    },
    "maze_center": { step: 8, title: "The Heart of the Maze", desc: "A glowing glade. A **Nymph** guards a pedestal. Go SOUTH.", exits: { south: "maze_entrance" }, items: ["sigil"],
        npcs: { "nymph": { name: "Sariel", intro: "The forest sees your intent.", 
            dialogue: { root: { text: "Take the Sigil. It is the only thing that opens the Sorcerer's Gate.", options: [{text:"Thank you, spirit.", next:"exit", align:1}] } } 
        }}
    },
    "sorcerer_gate": { step: 9, title: "The Sorcerer's Gate", desc: () => state.flags.gate_open ? "The gate is open. The Frozen Peaks lie NORTH." : "A massive iron gate blocks the path NORTH.", exits: { south: "mountain_pass", north: "frozen_peaks" },
        condition: (d) => (d === "north" && !state.flags.gate_open) ? "The gate is magically sealed." : null,
        interactions: { "sigil": { flag: "gate_open", msg: "The gate grinds open!" } }
    },
    "frozen_peaks": { step: 10, title: "Frozen Peaks", desc: "Blinding snow. A **Hermit** huddles by a fire. A chasm is NORTH.", exits: { south: "sorcerer_gate", north: "invisible_bridge" },
        npcs: {
            "hermit": { name: "The Hermit", intro: "Cold... so cold...", 
            dialogue: { root: { text: "The bridge North is invisible. Only 'Dragon-Fire Ale' can reveal it.", options: [{text:"Where can I get that?", next:"ale"}, {text:"Move aside, old man.", next:"exit", align:-2}] },
                       ale: { text: "The Barman Boran has a secret stash. You'll need to answer his riddle.", options: [{text:"I'll go back to the tavern.", next:"exit"}] }
            }}
        }
    },
    "invisible_bridge": { step: 11, title: "The Crystal Chasm", desc: () => state.flags.bridge_visible ? "A shimmering bridge leads NORTH to the Citadel." : "A bottomless drop. There is nothing but air to the NORTH.", exits: { south: "frozen_peaks", north: "citadel_gate" },
        condition: (d) => (d === "north" && !state.flags.bridge_visible) ? "You would fall to your death!" : null,
        interactions: { "ale": { flag: "bridge_visible", msg: "You drink the ale. Your eyes glow, and a bridge appears!" } }
    },
    "citadel_gate": { step: 12, title: "Citadel Gate", desc: "A silent obsidian fortress. A **Guard** stands here. NORTH into the tower.", exits: { south: "invisible_bridge", north: "citadel_interior" },
        npcs: { "guard": { name: "The Iron Sentinel", intro: "None pass the Sorcerer.", 
            dialogue: { root: { text: "Unless you have the Royal Writ, I will strike you down.", options: [{text:"How do I get a Writ?", next:"writ"}, {text:"[ATTACK GUARD]", next:"fight", align:-5}] },
                       writ: { text: "Only the Elder in Oakhaven can grant one. Begone.", options: [{text:"I'll go talk to the Elder.", next:"exit"}] },
                       fight: { text: "You strike the Guard! He falls, but your soul darkens.", options: [{text:"Proceed North.", next:"exit", flag:"guard_dead"}] }
            }}
        },
        condition: (d) => (d === "north" && !state.flags.guard_dead && !state.flags.has_writ) ? "The Guard blocks you." : null
    },
    "citadel_interior": { step: 15, title: "Citadel Great Hall", desc: "Cold marble. To the WEST is a Library, to the NORTH is the Throne.", exits: { south: "citadel_gate", west: "library", north: "throne_room" }, items: [] },
    "library": { step: 16, title: "The Forbidden Library", desc: "Ancient scrolls. You find a **Dispel_Scroll**. Go EAST.", exits: { east: "citadel_interior" }, items: ["scroll"], hint: "Take the scroll." },
    "throne_room": { step: 20, title: "The Throne of Shadow", desc: "The **Sorcerer** sits here, holding the Sun Gem. This is the end.", exits: {}, 
        npcs: {
            "sorcerer": { name: "Malakor", intro: "So, the little hero arrives.", 
            dialogue: {
                root: { text: "The world is better in darkness. Join me, or perish.", options: [
                    {text:"I will never join you! [USE SCROLL]", next:"defeat", align:10},
                    {text:"You are right. Let the world burn.", next:"join", align:-20},
                    {text:"I just want the gem. [STEAL IT]", next:"steal", align:-5}
                ]},
                defeat: { text: "The scroll dispels his power! He vanishes! You hold the Sun Gem.", options: [{text:"FINISH", next:"ending"}] },
                join: { text: "He laughs. Together, you rule the darkness.", options: [{text:"FINISH", next:"ending"}] },
                steal: { text: "You grab the gem and run, leaving the Sorcerer alive to plot again.", options: [{text:"FINISH", next:"ending"}] }
            }}
        }
    }
};

/** 2. ENGINE **/
const display = document.getElementById('display');
const inputField = document.getElementById('cmd-input');

function startGame() {
    document.getElementById('intro-overlay').style.display = 'none';
    state.gameActive = true;
    render();
}

function print(text, cls = "") {
    const p = document.createElement('p'); if (cls) p.className = cls;
    p.innerHTML = text; display.appendChild(p);
    display.scrollTop = display.scrollHeight;
}

function updateHUD() {
    const room = world[state.current];
    document.getElementById('stat-loc').innerText = `Location: ${room.title}`;
    document.getElementById('stat-step').innerText = `Step: ${room.step}/20`;
    let alignTxt = state.alignment > 5 ? "Heroic" : state.alignment < -5 ? "Ruthless" : "Neutral";
    document.getElementById('stat-align').innerText = `Moral: ${alignTxt}`;
}

function render() {
    const room = world[state.current];
    display.innerHTML = "";
    print(room.title, "room-title");
    print(typeof room.desc === 'function' ? room.desc() : room.desc);
    if (room.items?.length) print(`Items: <span style="color:var(--cga-cyan)">${room.items.join(", ")}</span>`);
    const npcs = Object.keys(room.npcs || {});
    if (npcs.length) print(`People: <span class="npc-name">${npcs.join(", ").toUpperCase()}</span>`);
    updateHUD();
}

function displayDialogue() {
    const npc = state.activeNPC.data;
    const node = npc.dialogue[state.activeNPC.node];
    display.innerHTML = "";
    print(npc.name, "npc-name");
    print(`"${node.text}"`, "npc-text");
    node.options.forEach((opt, i) => { print(`${i + 1}. ${opt.text}`, "user-cmd"); });
}

function handle(raw) {
    if (!state.gameActive) return;
    const input = raw.toLowerCase().trim();
    if (state.activeNPC) {
        const choice = parseInt(input) - 1;
        const node = state.activeNPC.data.dialogue[state.activeNPC.node];
        if (node.options[choice]) {
            const opt = node.options[choice];
            if (opt.align) state.alignment += opt.align;
            if (opt.flag) state.flags[opt.flag] = true;
            if (opt.next === "exit") { state.activeNPC = null; render(); }
            else if (opt.next === "ending") { renderEnding(); }
            else { state.activeNPC.node = opt.next; displayDialogue(); }
        }
        return;
    }

    print(`> ${raw}`, "user-cmd");
    const parts = input.split(" ");
    const verb = parts[0];
    const noun = parts[parts.length - 1];
    const room = world[state.current];

    if (["north", "south", "east", "west", "up", "down"].includes(verb) || (verb === "go" && ["north", "south", "east", "west", "up", "down"].includes(noun))) {
        const dir = ["north", "south", "east", "west", "up", "down"].includes(verb) ? verb : noun;
        if (room.exits[dir]) {
            const blocked = room.condition ? room.condition(dir) : null;
            if (blocked) print(blocked, "error-text");
            else { state.current = room.exits[dir]; render(); }
        } else print("Dead end.");
    } 
    else if (verb === "talk") {
        const target = room.npcs[noun] || Object.values(room.npcs)[0];
        if (target) { state.activeNPC = { data: target, node: "root" }; displayDialogue(); }
        else print("No one here.");
    }
    else if (verb === "take") {
        if (room.items?.includes(noun)) {
            state.inv.push(noun);
            room.items = room.items.filter(i => i !== noun);
            print(`Taken: ${noun}`);
        } else print("Nothing to take.");
    }
    else if (verb === "use") {
        if (state.inv.includes(noun)) {
            const interact = room.interactions?.[noun];
            if (interact) {
                print(interact.msg);
                if (interact.get) state.inv.push(interact.get);
                if (interact.flag) state.flags[interact.flag] = true;
                state.inv = state.inv.filter(i => i !== noun);
                render();
            } else print("Nothing happens.");
        } else print("You don't have that.");
    }
    else if (verb === "inv") print("Inv: " + (state.inv.join(", ") || "Empty"));
    else if (verb === "help") print("Hint: " + room.hint);
}

function renderEnding() {
    state.gameActive = false;
    display.innerHTML = "";
    let title = "", text = "";
    if (state.alignment > 10) { title = "THE HOLY GUARDIAN"; text = "You saved Aethelgard and restored the sun. Songs will be sung of your mercy."; }
    else if (state.alignment < -10) { title = "THE DARK LORD"; text = "You took the throne for yourself. The world remains in shadow, but you are its master."; }
    else { title = "THE GHOST OF THE PEAKS"; text = "You finished the job, but lost yourself in the process. You wander the peaks forever."; }
    print(`<h1 style="color:var(--cga-yellow)">${title}</h1>`);
    print(text);
    print(`<button class="btn" onclick="location.reload()">REPLAY</button>`);
}

inputField.addEventListener('keydown', (e) => { if (e.key === 'Enter') { handle(inputField.value); inputField.value = ''; } });
</script>
</body>
</html>
