<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aethelgard: The Hero's Journey</title>
    <style>
        :root { 
            --cga-blue: #0000AA; --cga-cyan: #55FFFF; --cga-white: #FFFFFF; 
            --cga-magenta: #FF55FF; --cga-yellow: #FFFF55; --cga-red: #FF5555;
        }
        body { background: #000; color: var(--cga-white); font-family: 'Courier New', monospace; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        #game-container { width: 100%; max-width: 900px; height: 100vh; display: flex; flex-direction: column; border-left: 2px solid #333; border-right: 2px solid #333; position: relative; }
        
        /* Opening Instruction Screen */
        #intro-overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: #000; z-index: 100; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
            border: 10px double var(--cga-blue); box-sizing: border-box; padding: 40px;
        }

        #status-bar { background: var(--cga-blue); color: var(--cga-white); padding: 8px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--cga-white); font-size: 0.8rem; }
        #art-display { background: #000; color: var(--cga-cyan); padding: 10px; text-align: center; border-bottom: 1px solid #222; white-space: pre; font-size: 0.7rem; line-height: 1.1; height: 140px; }
        #display { flex-grow: 1; overflow-y: auto; padding: 25px; line-height: 1.5; background: #050505; }
        #input-area { background: #111; padding: 15px; border-top: 2px solid var(--cga-white); display: flex; align-items: center; }
        #cmd-input { background: transparent; border: none; color: var(--cga-cyan); font-family: inherit; font-size: 1.1rem; width: 100%; outline: none; margin-left: 10px; }
        
        .room-title { color: var(--cga-magenta); font-size: 1.3rem; font-weight: bold; text-decoration: underline; display: block; }
        .npc-text { color: var(--cga-yellow); font-style: italic; }
        .npc-name { color: var(--cga-magenta); font-weight: bold; }
        .user-cmd { color: var(--cga-cyan); font-weight: bold; margin: 10px 0 2px 0; }
        .exit-list { color: var(--cga-yellow); font-weight: bold; margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px; }
        .btn-start { background: var(--cga-magenta); color: #000; padding: 15px 30px; border: none; font-family: inherit; font-weight: bold; cursor: pointer; font-size: 1.2rem; margin-top: 20px; }
        .btn-start:hover { background: var(--cga-white); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="intro-overlay">
        <h1 style="color:var(--cga-cyan)">AETHELGARD: SHADOW OF THE SUN</h1>
        <p style="max-width: 600px;">The world has fallen into darkness. As the last Guardian, you must find the Sun Gem and defeat the Sorcerer Malakor.</p>
        <div style="text-align: left; background: #111; padding: 20px; border: 1px solid var(--cga-blue); margin: 20px 0;">
            <p>• <b>GO [NORTH/SOUTH/etc]</b> to move between areas.</p>
            <p>• <b>TAKE [ITEM]</b> to add things to your pack.</p>
            <p>• <b>TALK [PERSON]</b> to begin a conversation.</p>
            <p>• <b>GIVE [ITEM]</b> to an NPC to progress.</p>
            <p>• <b>INV</b> to check your current items.</p>
        </div>
        <button class="btn-start" onclick="startGame()">BEGIN QUEST</button>
    </div>

    <div id="status-bar">
        <span id="stat-loc">Location: ???</span>
        <span id="stat-step">Step: 1/20</span>
        <span id="stat-score">Score: 0</span>
    </div>
    <div id="art-display"></div>
    <div id="display"></div>
    <div id="input-area">
        <span style="color:var(--cga-cyan)">▶</span>
        <input type="text" id="cmd-input" autocomplete="off">
    </div>
</div>

<script>
/** 1. DATA **/
let state = { current: "forest", inv: [], flags: {}, score: 0, turns: 0, activeNPC: null };

const arts = {
    nature: "\n   ^  ^  ^   \n  / \\/ \\/ \\  \n /   \\  /  \\ \n/_   _\\/_   _\\\n  | |    | |  ",
    town: "\n     _L_     \n   _/__\\_    \n  |      |   \n  |  []  |   \n~~|______|~~~",
    tower: "\n     [|]     \n     | |     \n    /   \\    \n   |     |   \n   |_|_|_|   "
};

const world = {
    "forest": {
        step: 1, title: "The Forest Edge", art: arts.nature,
        desc: () => "The air is heavy with mist. " + (world.forest.items.includes("coin") ? "A **coin** glitters in the mud." : "The grass is trampled here."),
        exits: { north: "square", west: "wagon" }, items: ["coin"]
    },
    "wagon": {
        step: 2, title: "Ruined Wagon", art: arts.nature,
        desc: () => "A destroyed merchant cart. " + (world.wagon.items.includes("hammer") ? "A **hammer** lies among the debris." : "Empty crates are scattered about."),
        exits: { east: "forest" }, items: ["hammer"]
    },
    "square": {
        step: 3, title: "Oakhaven Square", art: arts.town,
        desc: "The center of Oakhaven. An **Elder** sits by a dry fountain.",
        exits: { south: "forest", north: "pass", west: "tavern" },
        npcs: { "elder": { name: "Elder Haim", intro: "The darkness grows, traveler.", dialogue: { root: { text: "Malakor has the Sun Gem in the Frozen Peaks. You'll need a Sigil from the maze to open his gate.", options: [{text:"I will find it.", next:"exit"}] } } } }
    },
    "pass": {
        step: 4, title: "The High Pass", art: arts.nature,
        desc: () => state.flags.has_key ? "The Blacksmith nods as you pass." : "A **Blacksmith** is frantically searching the dirt for his lucky coin.",
        exits: { south: "square", north: "gate" },
        npcs: { "blacksmith": { name: "Ironheart", intro: "I can't work without my coin!", dialogue: { root: { text: "Return my silver piece and the Silver Key is yours.", options: [{text:"I'm looking for it.", next:"exit"}] } } } },
        interactions: { "coin": { npc: "blacksmith", msg: "Ironheart cheers! He hands you the **silver_key**.", get: "silver_key", flag: "has_key" } }
    },
    "tavern": {
        step: 5, title: "Sleeping Dragon Tavern", art: arts.town,
        desc: "A warm, dim pub. A hatch leads DOWN into the darkness.",
        exits: { east: "square", down: "cellar" },
        condition: (d) => (d === "down" && !state.inv.includes("silver_key")) ? "The hatch is locked with a silver padlock." : null,
        npcs: { "barman": { name: "Boran", intro: "Watch out for the rats downstairs.", dialogue: { root: { text: "My lantern is in the cellar. If you can clear the rats, it's yours.", options: [{text:"I'll try.", next:"exit"}] } } } }
    },
    "cellar": {
        step: 6, title: "The Dark Cellar", art: arts.town,
        desc: () => state.flags.rats ? "The rats have fled. A **lantern** is here on a crate." : "Giant rats hiss at you! You need something to drive them back.",
        exits: { up: "tavern" },
        interactions: { "hammer": { flag: "rats", msg: "You smash a barrel! The loud noise scares the rats away. You spot a **lantern**.", get: "lantern" } }
    },
    "gate": {
        step: 10, title: "The Sorcerer's Gate", art: arts.tower,
        desc: () => state.flags.gate ? "The iron gate stands open to the NORTH." : "A massive gate of obsidian blocks the way NORTH.",
        exits: { south: "pass", north: "peaks" },
        condition: (d) => (d === "north" && !state.flags.gate) ? "The gate is sealed by a magical Sigil slot." : null,
        interactions: { "sigil": { flag: "gate", msg: "The Sigil glows. The gate grinds open!", score: 50 } }
    }
    // ... Additional rooms would follow this pattern
};

/** 2. ENGINE **/
const display = document.getElementById('display');
const artBox = document.getElementById('art-display');
const inputField = document.getElementById('cmd-input');

function startGame() {
    document.getElementById('intro-overlay').style.display = 'none';
    render();
    inputField.focus();
}

function print(text, cls = "") {
    const p = document.createElement('p'); if (cls) p.className = cls;
    p.innerHTML = text; display.appendChild(p);
    display.scrollTop = display.scrollHeight;
}

function updateHUD() {
    const r = world[state.current] || {title: "???", step: 0};
    document.getElementById('stat-loc').innerText = `Location: ${r.title}`;
    document.getElementById('stat-step').innerText = `Step: ${r.step}/20`;
    document.getElementById('stat-score').innerText = `Score: ${state.score}`;
}

function render() {
    const r = world[state.current];
    if (!r) return;
    display.innerHTML = "";
    artBox.innerText = r.art || arts.nature;
    
    print(r.title, "room-title");
    print(typeof r.desc === "function" ? r.desc() : r.desc);
    
    if (r.items?.length) print(`Items here: <span style="color:var(--cga-cyan)">${r.items.join(", ")}</span>`);
    const n = Object.keys(r.npcs || {});
    if (n.length) print(`People: <span class="npc-name">${n.join(", ").toUpperCase()}</span>`);
    
    // NEW: Available Directions after every interaction
    const exits = Object.keys(r.exits).map(e => e.toUpperCase());
    print(`Available Exits: ${exits.join(", ")}`, "exit-list");
    
    updateHUD();
}

function handle(raw) {
    const cmd = raw.toLowerCase().trim();
    if (!cmd) return;
    const parts = cmd.split(" ");
    const verb = parts[0];
    const room = world[state.current];

    if (state.activeNPC) {
        const choice = parseInt(cmd) - 1;
        const node = state.activeNPC.data.dialogue[state.activeNPC.node];
        if (node.options[choice]) {
            const o = node.options[choice];
            if (o.next === "exit") { state.activeNPC = null; render(); }
            else { state.activeNPC.node = o.next; displayDialogue(); }
        }
        return;
    }

    print(`> ${raw}`, "user-cmd");

    // Movement
    if (["north","south","east","west","up","down"].includes(verb) || (verb === "go" && parts[1])) {
        const dir = ["north","south","east","west","up","down"].includes(verb) ? verb : parts[1];
        if (room.exits[dir]) {
            const err = room.condition ? room.condition(dir) : null;
            if (err) print(err, "error-text");
            else { state.current = room.exits[dir]; render(); }
        } else print("You can't go that way.", "error-text");
    } 
    // Talk
    else if (verb === "talk") {
        const t = room.npcs[parts[parts.length-1]] || Object.values(room.npcs || {})[0];
        if (t) { state.activeNPC = { data: t, node: "root" }; displayDialogue(); }
        else print("No one here to talk to.");
    }
    // Take
    else if (verb === "take" || verb === "get") {
        const i = parts[parts.length-1];
        if (room.items?.includes(i)) {
            state.inv.push(i);
            room.items = room.items.filter(x => x!==i);
            print(`You picked up the ${i}.`);
            render(); // Re-render to show updated items and directions
        } else print("That isn't here.");
    }
    // Give / Use
    else if (verb === "give" || verb === "use" || verb === "offer") {
        const i = state.inv.find(x => cmd.includes(x));
        const act = room.interactions?.[i];
        if (act) {
            print(act.msg, "npc-text");
            if (act.get) state.inv.push(act.get);
            if (act.flag) state.flags[act.flag] = true;
            state.inv = state.inv.filter(x => x!==i);
            state.score += 20;
            // Interaction complete, show the room again with exits
            setTimeout(render, 1500); 
        } else print("Nothing happens.");
    }
    else if (verb === "inv") print("Inventory: " + (state.inv.join(", ") || "Empty"));
}

function displayDialogue() {
    const n = state.activeNPC.data;
    const node = n.dialogue[state.activeNPC.node];
    display.innerHTML = "";
    artBox.innerText = `[ DIALOGUE: ${n.name.toUpperCase()} ]`;
    print(n.name, "npc-name");
    print(`"${node.text}"`, "npc-text");
    node.options.forEach((o, i) => print(`${i + 1}. ${o.text}`, "user-cmd"));
}

inputField.addEventListener('keydown', (e) => { if (e.key === 'Enter') { handle(inputField.value); inputField.value = ''; } });
</script>
</body>
</html>
